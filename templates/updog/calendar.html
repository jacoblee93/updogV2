{% extends 'updog/base.html' %}

{% load static %}

{% block above_calendar_block %}

<div class="hero-unit">
  <br />
  <br />

  <center>
    <h1>What's Up, {{ user.first_name }}?</h1>
  </center>
</div>

<script>
  var varRepeatingEvent = "<br/>Event does not repeat";
  // this function is called when a user selects "None" for
  // repeating events
  function clickedNone() {
    console.log("clicked None!");
    return "<br/>Event does not repeat";
  }
  function clickedEveryDay() {
    console.log("clicked Every Day!");
    return "<br/>Event repeats every day";
  }
  function clickedEveryWeek() {
    console.log("clicked Every Week!");
    return "<br/>Event repeats every week";
  }
  function clickedEvery2Weeks() {
    console.log("clicked Every 2 Weeks!");
    return "<br/>Event repeats every 2 weeks";
  }
  function clickedEvery4Weeks() {
    console.log("clicked Every 4 Weeks!");
    return "<br/>Event repeats every 4 weeks";
  }

  function makeRepeatingEventNonRepeating(event) {
    prev_event = $('#calendar').fullCalendar('clientEvents', event.prev_repeated_event);
    next_event = $('#calendar').fullCalendar('clientEvents', event.next_repeated_event);

    if (prev_event.length != 0) {
      if (next_event.length != 0) {
        // if we are deleting an event between two repeated events, point those repeated events to each other
        prev_event[0].next_repeated_event = event.next_repeated_event;
        next_event[0].prev_repeated_event = event.prev_repeated_event;
      }
      else {
        // if we are deleting an event at the end of a list of repeated events, make the second to last event point to nothing (make it the last event)
        prev_event[0].next_repeated_event = -1;
      }
    }
    else if (next_event.length != 0) {
      // if we are deleting the first event in a list of repeated events, make the second event have no previous event (make it the first event)
      next_event[0].prev_repeated_event = -1;
    }
  }


  function resolve_event_downtime_conflicts(downtimes) {
    if (downtimes.length > 0) {
      // downtimes is a list of downtimes and moved_event_or_downtime is an event
      if (downtimes[0].model == "udCalendar.downtime") {
        var new_downtimes = [];

        for (var i = 0; i < downtimes.length; i++) {
          if (downtimes[i].fields.start_time == downtimes[i].fields.end_time) {
            $('#calendar').fullCalendar('removeEvents', -downtimes[i].pk);
          }
          else new_downtimes.push(downtimes[i]);
        }
        var updated_downtimes = make_events(new_downtimes, 'green', "{{ username }}", false, false);

        for (var i = 0; i < new_downtimes.length; i++) {
          $('#calendar').fullCalendar('removeEvents', -new_downtimes[i].pk);
          $('#calendar').fullCalendar('rerenderEvents');
          $('#calendar').fullCalendar('renderEvent', updated_downtimes[i], stick=true);
        }
      }
      else alert("can't pass events to function resolve_event_downtime_conflicts!");
    }
  }

</script>

{% endblock %}

{% block calendar_block %}

<!-- updated to fit calendar onto window -->
<style>
  div#scroll-able {
    height: 410px;
    overflow: scroll;
  }
</style>

<!-- rolling both searchbars into one -->
<div>
  <script type="text/javascript">
    $(function() {
      $(".submit-friends").click(function() {
        var name = $("#search-friends").val();

        if (name == '')
        {
          $.ajax({
            type: "GET",
            url: "/calendar/get_friends/",
            data: {'user': '{{ user }}'},
            success: function(data) {

              real_data = JSON.parse(data);
              fl = real_data.length;
              userhtml = '';
              if (fl != 0) {

                for (var i = 0; i < fl; i++) {
                  userhtml = userhtml + '<a class="list-group-item" onclick="getevents(\'' + real_data[i].fields.username + '\')" id="friend_' + real_data[i].fields.username + '"><div><img class="img-rounded" src="http://updog-assets.s3.amazonaws.com/media/profile_pictures/' + real_data[i].fields.username + '-social.jpg" alt = "profpic" width = "50" height = "50"><span class="frand">  ' + real_data[i].fields.first_name + ' ' + real_data[i].fields.last_name + '</span></div></a>';
                };
              } else {
                userhtml = '<strong>No friends.</strong>';
              };

              $(".frandz").html(userhtml);
              for (var i = 0; i < fl; i++) {
                hover_stuff(real_data[i]);
              };
            } 
          });
}
else
{
  $.ajax({
    type: "GET",
    url: "/calendar/find_friends/",
    data: {"search": name,
  },
  success: function(data) {
    if (data != "no friends") {
      users_returned = JSON.parse(data[0]);
      friend_status = data[1];
      userhtml = "";
      real_friends = [];
      if (users_returned.length > 0) {
        var l = users_returned.length;

        for (var i = 0; i < l; i++) {
          if (friend_status[i] == 1) {
            userhtml = userhtml + '<a class="list-group-item" onclick="getevents(\'' + users_returned[i].fields.username + '\')" id="friend_' + users_returned[i].fields.username + '"><div><img class="img-rounded" src="http://updog-assets.s3.amazonaws.com/media/profile_pictures/' + users_returned[i].fields.username + '-social.jpg" alt = "profpic" width = "50" height = "50"><span class="frand">  ' + users_returned[i].fields.first_name + ' ' + users_returned[i].fields.last_name + '</span></div></a>';

            real_friends.push(i);
          }
          else {
            userhtml = userhtml + '<div><a class="list-group-item"><img class="img-rounded" src="http://updog-assets.s3.amazonaws.com/media/profile_pictures/' + users_returned[i].fields.username + '-social.jpg" alt = "profpic" width = "50" height = "50">  ' + users_returned[i].fields.first_name + ' ' +  users_returned[i].fields.last_name + '<div style="float:right"><div id="add-button' + users_returned[i].fields.username + '"><button type="button" onclick="send_friend_request(\'' + users_returned[i].fields.username + '\', \'' + i +'\')"> add </button></div></div><div id="div' + i + '"></div></a></div>';
          }
        };

        $(".frandz").html(userhtml);
        rfl = real_friends.length;
        for (var i =  0; i < rfl; i++) {
          hover_stuff(users_returned[real_friends[i]]);
        };
      }
      else {
        $(".frandz").html('No friends found');
      }
    }
  }
  });
}
return false;
});
});
</script>
</div>


<!-- THIS IS THE CALENDAR!!! -->
<div class="span12">
  <div class="row-fluid">
    <div class="col-xs-6 col-sm-9">
      <div id='calendar'></div>
      <div class="ui-helper-hidden" id="calendar-details" title="Event Details">
        <p>Event details</p>
      </div>
    </div>

    <!-- this is the friends tab -->
    {% if user.is_authenticated %}
    <div class="col-xs-6 col-sm-3 sidebar-offcanvas" id="sidebar" role="navigation">
      <div class="list-group">
        <form class="list-group-item list-group-item-info" method="post" name="form">Search for Friends:<input id="search-friends" size="17" name="search" type="text" />
          <input type="submit" value="Search" class="submit-friends"/>
          Empty search to reset
          <span class="error" style="display:none"> Please Enter Valid Data</span>
          <span class="success" style="display:none"></span></a>
        </form>

        <div id="scroll-able"><div class="frandz"></div></div>

      </div>
      <!-- this is the searchbar -->
      <!--<div id="scroll-able">-->
      <!--<div class="list-group">
        <form class="list-group-item list-group-item-info" method="post" name="form">
          Find friends to add:<input id="search" size="17" name="search" type="text" />
          <input type="submit" value="Search" class="submit"/>
          <span class="error" style="display:none"> Please Enter Valid Data</span>
          <span class="success" style="display:none"></span></a>
        </form>
        <div id="scroll-able"><div class="output"></div></div>
      </div>--><!--/span-->
      <!--</div>-->
    </div>
    {% endif %}
    <br>
  </div>
</div>

<script>

  function send_friend_request(new_friend, i) {
    console.log("sending frined request")
    $.ajax({
      type: "POST",
      url: "/calendar/send_friend_request/",
      data: {'new_friend': new_friend, 'i': i},
      success: function(data) {
        var s = data.indexOf(',');
        var data1 = data.substring(0,s);
        var data2 = data.substring(s+1, data.length);
        if (data1 === "Request Pending") {
          $("#div"+data2).text("Request Pending");
          $("#add-button"+new_friend).remove();
        }
        else {
          $("#div"+data2).text("friend request sent");
          $("#add-button"+new_friend).remove();
        }

      }
    });
  }

  function get_friends(user) {
    $.ajax({
      type: "GET",
      url: "/calendar/get_friends/",
      data: {'user': user},
      success: function(data) {
        real_data = JSON.parse(data);
      // everything before this pulls friends
      fl = real_data.length
      userhtml = ''
      if (fl != 0) {
        userhtml = userhtml + '<a class="list-group-item active">Friends:</a>';
        
        for (var i = 0; i < fl; i++) {
          userhtml = userhtml + '<a class="list-group-item" onclick="getevents(\'' + real_data[i].fields.username + '\')" id="friend_' + real_data[i].fields.username + '"><div><img class="img-rounded" src="http://updog-assets.s3.amazonaws.com/media/profile_pictures/' + real_data[i].fields.username + '-social.jpg" alt = "profpic" width = "50" height = "50"><span class="frand">  ' + real_data[i].fields.first_name + ' ' + real_data[i].fields.last_name + '</span></div></a>';
        };
      } else {
        userhtml = '<strong>No friends.</strong>';
      };
      $(".frandz").html(userhtml);
      for (var i = 0; i < fl; i++) {
        hover_stuff(real_data[i]);
      };
    } 
  });
}

function hover_stuff(friend) {
  hover_functions = {
    sensitivity: 3,
    interval: 50,
    timeout: 50,
    over: function on_hover() {
      var obj = friend.fields.username;
      $.ajax({
        type: "POST",
        url: "/calendar/get_friends_downtimes/",
        data: {'friend': obj, 'display_date': $('#calendar').fullCalendar('getDate').toUTCString(),},
        success: function(data) {

          var our_data = JSON.parse(data);
          var get_some_events = make_events(our_data, 'orange', obj, true, false);

          if (get_some_events) {
            existing_events = $("#calendar").fullCalendar('clientEvents');

            for (var i = 0; i < get_some_events.length; i++) {
              var is_unique = true;
              for (var j = 0; j < existing_events.length; j++) {
                if (get_some_events[i].id == existing_events[j].id) {
                  is_unique = false;
                }
              }
              if (is_unique) {
                $("#calendar").fullCalendar('renderEvent', get_some_events[i], stick=true);
              }
            }

          }
        },
      });

    },
    out: function off_hover() {
      var obj = friend;
      existing_events = $("#calendar").fullCalendar('clientEvents');
      for (var i = 0; i < existing_events.length; i++) {
        if (existing_events[i].owner === "hover") {
          $('#calendar').fullCalendar('removeEvents', existing_events[i].id);
        }
      }
      $('#calendar').fullCalendar('rerenderEvents');
    }
  }
  $( "#friend_" + friend.fields.username).hoverIntent(hover_functions);
}

function accept_friend_request(new_friend) {
  $.ajax({
    type: "POST",
    url: "/calendar/accept_friend_request/",
    data: {'new_friend': new_friend},
    success: function(data){
      get_friends('{{ user }}');
    }
  });
}

function reject_friend_request(new_friend) {
  $.ajax({
    type: "POST",
    url: "/calendar/reject_friend_request/",
    data: {'new_friend': new_friend},
    success: function(data){
      console.log(data)
    }
  });
}

function getevents(obj) {
  $.ajax({
    type: "POST",
    url: "/calendar/get_friends_downtimes/",
    data: {'friend': obj, 'display_date': $('#calendar').fullCalendar('getDate').toUTCString(),},
    success: function(data) {


      var our_data = JSON.parse(data);
      var get_some_events = make_events(our_data, 'orange', obj, false, false);
      if (get_some_events) {

        existing_events = $("#calendar").fullCalendar('clientEvents');

        for (var i = 0; i < get_some_events.length; i++) {
          var is_unique = true;
          for (var j = 0; j < existing_events.length; j++) {
            if (get_some_events[i].id == existing_events[j].id) {
              if (existing_events[j].owners[0] != "hover") {
                is_unique = false;
              }
                  // existing event owner is hover
                  else {
                    $('#calendar').fullCalendar('removeEvents', existing_events[j].id); // remove the one with 'hover' owner
                  }

                }
              }
              if (is_unique) {
                $("#calendar").fullCalendar('renderEvent', get_some_events[i], stick=true);
                
              }
            }
            var test = document.getElementById('friend_'+obj);  
            test.setAttribute("onclick", "erase_events("+JSON.stringify(obj)+")");

          }
        },
      });

}
function erase_events(obj) {

  existing_events = $("#calendar").fullCalendar('clientEvents');
  for (var i = 0; i < existing_events.length; i++) {
    able = false;
    for (var j = 0; j < existing_events[i].owners.length; j++) {
      if (existing_events[i].owners[j] == obj) able = true;
    }

    if (able) {
      $('#calendar').fullCalendar('removeEvents', existing_events[i].id);
    }
  }
  $('#calendar').fullCalendar('rerenderEvents');

  var test = document.getElementById('friend_'+obj);
  test.setAttribute("onclick", "getevents("+JSON.stringify(obj)+")");


}
    // this function will delete all the repeating events
    function deleteRepeatingEventsFunction(event) {
      temp_event = event;

      next_event = $('#calendar').fullCalendar('clientEvents', event.next_repeated_event);

      // if there is a repeated event before this event, update it so that it no longer has a next_repeated_event.  After doing this, check if it has any previous events; if not, it no longer belongs to a linked list of repeated events, so it should be treated as a non-repeating event
      prev_event = $('#calendar').fullCalendar('clientEvents', event.prev_repeated_event);
      if (prev_event.length != 0) {
        prev_event[0].next_repeated_event = -1;
        if (prev_event[0].prev_repeated_event == -1)
          prev_event[0].repeating_time_delta = -1;
      }

      while (temp_event.next_repeated_event != -1) {
        prev_event = temp_event;
        console.log (temp_event = $('#calendar').fullCalendar('clientEvents', prev_event.next_repeated_event)[0]);

        $.ajax({
          type: "POST",
          url: "/calendar/remove_event/",
          data: {"pk": prev_event.id},
          success: function(data) {
            console.log( "ajax to remove1!!!" );
          },
        })
        $('#calendar').fullCalendar('removeEvents', prev_event.id);
        $('#calendar').fullCalendar('rerenderEvents');
      }
      $.ajax({
        type: "POST",
        url: "/calendar/remove_event/",
        data: {"pk": temp_event.id},
        success: function(data) {
          console.log( "ajax to remove2!!!" );
        },
      })

      $('#calendar').fullCalendar('removeEvents', temp_event.id);
    }

  </script>

  <div>
    <script>
    // This function converts a Date object, date, into a time of the form: 2:00 PM or 11:00 AM
    function getTime(date) {
      var local_time = date.toLocaleTimeString()
      var lt_length = local_time.length;

      return local_time.substring(0, lt_length - 6) + local_time.substring(lt_length - 3, lt_length)
    } 
    $(document).ready(function() {


      var date = new Date();
      var d = date.getDate();
      var m = date.getMonth();
      var y = date.getFullYear();

    // variables for dayClick double clicking capabilities
    var clickTimer;
    var doubleClick;

    var $dialog = $('#calendar-details').dialog({
      autoOpen: false,
      model: true,
      height: 300,
      width: 350
    });

    // this creates a datepicker object below the calendar
    $('#datepicker').datepicker({
      inline: true,
      onSelect: function(dateText, inst) {
        var d = new Date(dateText);
        $('#fullcalendar').fullCalendar('gotoDate', d);
      }
    }); 

    $('#calendar').fullCalendar(
    {
      viewDisplay: function(view) {

        // Displaying users events + downtimes in calendar
        var d = $('#calendar').fullCalendar('getDate');
        $.ajax({

          type: "POST",
          url: "/calendar/display/",
          data: {'display_date': d.toUTCString()},
          success: function(data) {
            var my_data = JSON.parse(data);
            var downtimes_vd = [];
            var events_vd = [];

            existing_events = $("#calendar").fullCalendar('clientEvents');
            for (var i = 0; i < my_data.length; i++) {
              unique = true;
              for (var j = 0; j < existing_events.length; j++) {

                if ((existing_events[j].id == my_data[i].pk || existing_events[j].id == -my_data[i].pk) && ((my_data[i].model == "udCalendar.downtime" && existing_events[j].is_event == false) || (my_data[i].model == "udCalendar.event" && existing_events[j].is_event == true))) {
                  unique = false;
                }
              }

              if (unique) {
                if (my_data[i].model == "udCalendar.downtime") {

                  downtimes_vd.push(my_data[i]);

                }
                else {
                  events_vd.push(my_data[i]);
                }
              }
            }
            var multiple_evs = make_events(events_vd, 'blue', '{{ username }}', false, true);
            var multiple_dts = make_events(downtimes_vd, 'green', '{{ username }}', false, false);
            var dts_and_evs;
            if (multiple_evs) {

              if (multiple_dts) {

                dts_and_evs = multiple_evs.concat(multiple_dts);
              }

              else dts_and_evs = multiple_evs;
            }
            else if (multiple_dts) dts_and_evs = multiple_dts;

            if (dts_and_evs) {
              for (var i = 0; i < dts_and_evs.length; i++) {
                $('#calendar').fullCalendar('renderEvent', dts_and_evs[i], stick = true);
              }
            }
          }

        });
},
header: {
  left: 'prev, month, agendaWeek',
  center: 'title',
  right: 'next',
},

titleFormat:"\'What's up, {{ user.first_name }}? \'",

selectable: {
  month: false,
  agenda: true
},
selecthelper: true,

      editable: false, // TESTING IT OUT AS FALSE, DONT KILL ME FRANKLYN
      // set the default view to be the agendaWeek view
      defaultView: 'agendaWeek',

      // failed attempt at importing googlecal
      //events: 'http://www.google.com/calendar/feeds/fdarnis%40princeton.edu/public/basic',

      allDaySlot: false,
      firstDay: date.getDay(),
      firstHour: 8,
      // makes calendar fit on screen
      height: 510,

      // Use below if you want something to happen after
      // clicking on an existing event in the calendar
      eventClick: function(event, jsEvent, view) {


        console.log("event.id = " + event.id + ", event.prev = " + event.prev_repeated_event + ", and event.next = " + event.next_repeated_event);


        if (view.name != 'month') {

          if (event.is_event) {
            $dialog.dialog({title:event.title});

            var party = document.createElement("button");
            party.className = "btn btn-primary party-button";
            party.setAttribute('type', "submit");
            party.setAttribute('data-toggle', "modal");
            party.setAttribute('data-target', ".schedule-modal");
            party.setAttribute('event', event.id);
            party.onclick = function() {
              $dialog.dialog('close');


              function who_is_invited(event_id) {
                var mydata;
                $.ajax({
                  type: "GET",
                  url: "/calendar/who_is_invited/",
                  async: false,
                  data: {
                    "event": event_id,
                  },
                  success: function(data) {
                    mydata = JSON.parse(data);
                  }
                });
                return mydata;
              }              
              var invite_list = who_is_invited(event.id);

              var owners_list;
              $.ajax({
                type: "GET",
                url: "/calendar/get_event_owners/",
                async: false,
                data: {
                  "pk": event.id,
                  "type": true,
                },
                success: function(data) {
                  owners_list = JSON.parse(data);
                }
              });


              var event_obj = $('#calendar').fullCalendar('clientEvents', event.id)[0];
              var invite_text = "";
              if (invite_list.length > 0) {  
                for (var k = 0; k < invite_list.length; k++) {

                  invite_text = invite_text + '<div id="added_' + invite_list[k].fields.username + '"><a class="list-group-item"><img class="img-rounded" src="http://updog-assets.s3.amazonaws.com/media/profile_pictures/' + invite_list[k].fields.username + '-social.jpg" alt = "profpic" width = "50" height = "50">  ' + invite_list[k].fields.first_name + ' ' + invite_list[k].fields.last_name + '<div style="float:right" id="undesirablebutton_' + invite_list[k].fields.username + '">Already Invited</div></a></div>'
                }
              }
              if (owners_list.length > 0) {
                for (var k = 0; k < owners_list.length; k++) {
                  if (owners_list[k].fields.username == '{{ username }}') {
                    invite_text = invite_text + '<div id="added_' + owners_list[k].fields.username + '"><a class="list-group-item"><img class="img-rounded" src="http://updog-assets.s3.amazonaws.com/media/profile_pictures/{{ username }}-social.jpg" alt = "profpic" width = "50" height = "50">  ' + 'Me' + '<div style="float:right" id="undesirablebutton_' + owners_list[k].fields.username + '">Already Attending</div></a></div>'
                  }
                  else {
                    invite_text = invite_text + '<div id="added_' + owners_list[k].fields.username + '"><a class="list-group-item"><img class="img-rounded" src="http://updog-assets.s3.amazonaws.com/media/profile_pictures/' + owners_list[k].fields.username + '-social.jpg" alt = "profpic" width = "50" height = "50">  ' + owners_list[k].fields.first_name + ' ' + owners_list[k].fields.last_name + '<div style="float:right" id="undesirablebutton_' + owners_list[k].fields.username + '">Already Attending</div></a></div>'
                  }

                }

              }
              $(".Invite-list").html("");
              $(".Invite-list").html(invite_text);

            }

            var partyEdit = document.createTextNode("Invite Friends");
            party.appendChild(partyEdit);

            var edit = document.createElement("button");
            edit.className = "btn btn-primary";
            edit.setAttribute('type', "submit");
            var textEdit = document.createTextNode("Edit Event");
            edit.appendChild(textEdit);

            edit.setAttribute('value', "Edit Event");
            edit.onclick = function() {

              $dialog.dialog('close');
              $dialog.dialog(
              {
                title:'Edit Event',
                width: 500,
                height: 250
              }
              );

              var activity_text = document.createElement("span");
              activity_text.innerHTML = 'Activity (optional): &nbsp';
              var activity = document.createElement("input");
              activity.setAttribute('type', "text");
              activity.setAttribute('name', "activity");
              activity.setAttribute('id', 'activity_field');

              var location_text = document.createElement("span");
              location_text.innerHTML = '<br/>Location (optional): ';
              var location = document.createElement("input");
              location.setAttribute('type', "text");
              location.setAttribute('name', "location");
              location.setAttribute('id', 'location_field');

          // find where the last index of the substring " in " exists.  Assume what
          // comes before is the activity and what comes after is the location.
          var i = 0;
          // the following handles what shows up in the fields when you click
          // "edit event" based on the event title
          if (event.title != "Busy") {
            if (event.title.substring(0, 8) != "Busy in ") {
              if (event.title.indexOf(" in ") > -1) {
                while (event.title.substring(i, event.title.length).indexOf(" in ") != -1) {
                  i = i + event.title.substring(i, event.title.length).indexOf(" in ");
                    // increment i by 3 because we look past the found " in "
                    i = i + 3;
                  }
                  if (i != -1) {
                    activity.setAttribute('value', event.title.substring(0, i - 3));
                  }
                  else activity.setAttribute('value', event.title);
                  if (i != -1) {
                    location.setAttribute('value', event.title.substring(i + 1, event.title.length));
                  }
                }
                else activity.setAttribute('value', event.title);
              }
              else {
                location.setAttribute('value', event.title.substring(8, event.title.length));
              }
            }

          // span makes it so there's no newline at the end, while "br" would
          // include the newline
          start_text = document.createElement("span");
          // &nbsp is a non-breaking whitespace character
          start_text.innerHTML = '<br/>Start Time: &nbsp&nbsp&nbsp&nbsp&nbsp';

          // dialog box's startTime input field
          var startTime = document.createElement("input");
          startTime.id = "txtStartTime";
          startTime.type = "text";
          startTime.className = 'input-small';
          startTime.style.width = "85px";
          // dialog box's endTime input field
          var endTime = document.createElement("input");
          endTime.id = "txtEndTime";
          endTime.type = "text";
          endTime.className = 'input-small';
          endTime.style.width = "85px";
          // is the time in the morning (AM) or afternoon (PM)
          var start_am_pm = "PM";
          var startHour = event.start.getHours();
          if (startHour == 0) {
            startHour = 12;
            start_am_pm = "AM";
          }
          else if (startHour < 12) {
            start_am_pm = "AM";
          }
          // if the time is PM, don't use military time (eg. 13:00 ==> 1:00)
          else if (startHour != 12) {
            startHour = startHour - 12;
          }
          var startMinute = event.start.getMinutes();
          // set the initial start time to be the time that was clicked to make the event
          startTime.setAttribute('value', startHour + ':' + startMinute + ' ' + start_am_pm);

          // increment the initial end time to be one hour (3.6e6 milliseconds) later than the initial start time
          var endDateObject = event.end;
          var end_am_pm = "PM";
          var endHour = endDateObject.getHours();
          if (endHour == 0) {
            endHour = 12;
            end_am_pm = "AM";
          }
          else if (endHour < 12) {
            end_am_pm = "AM";
          }
          else if (endHour != 12) {
            endHour = endHour - 12;
          }
          var endMinute = endDateObject.getMinutes();
          // set the initial start time to be the time that was clicked to make the event
          endTime.setAttribute('value', endHour + ':' + endMinute + ' ' + end_am_pm);

          // the box that holds the startTime timepicker
          var lblStartTime = document.createElement('label')
          lblStartTime.htmlFor = "txtStartTime";
          lblStartTime.appendChild(document.createTextNode('fromTime'));
          // the box that holds the endTime timepicker
          var lblEndTime = document.createElement('label')
          lblEndTime.htmlFor = "txtEndTime";
          lblEndTime.appendChild(document.createTextNode('toTime'));

          var newline = document.createElement("span");
          newline.innerHTML = ' <br/>';

          // span makes it so there's no newline at the end, while "br" would
          // include the newline
          date_text = document.createElement("span");
          // &nbsp is a non-breaking whitespace character
          date_text.innerHTML = '<br/>Event Dates: ';

          var startDate = document.createElement("input");
          startDate.id = "txtStartDate";
          startDate.type = "text";
          startDate.className = "datepicker";
          startDate.style.width = "85px";
          startDate.readonly = "readonly";

          // January is 0 so we add 1
          var startMonth = event.start.getMonth() + 1;
          if (startMonth < 10) {
            startMonth = '0' + startMonth;
          }
          var startDay = event.start.getDate();
          console.log(event.start);
          if (startDay < 10) {
            startDay = '0' + startDay;
          }
          // when editing an event, the start date is displayed
          startDate.setAttribute('value', startMonth + '/' + startDay + '/' + event.start.getFullYear());
          var lblStartDate = document.createElement('label')
          lblStartDate.htmlFor = "txtStartDate";
          lblStartDate.appendChild(document.createTextNode('fromDate'));

          to_text = document.createElement("span");
          // &nbsp is a non-breaking whitespace character
          to_text.innerHTML = '&nbsp to &nbsp';

          var endDate = document.createElement("input");
          endDate.id = "txtEndDate";
          endDate.type = "text";
          endDate.className = "datepicker";
          endDate.style.width = "85px";
          endDate.readonly = "readonly";

          // January is 0 so we add 1
          var endMonth = event.end.getMonth() + 1;
          if (endMonth < 10) {
            endMonth = '0' + endMonth;
          }
          var endDay = event.end.getDate();
          if (endDay < 10) {
            endDay = '0' + endDay;
          }

          // when editing an event, the end date is displayed
          endDate.setAttribute('value', endMonth + '/' + endDay + '/' + event.end.getFullYear());

          var lblEndDate = document.createElement('label')
          lblEndDate.htmlFor = "txtEndDate";
          lblEndDate.appendChild(document.createTextNode('toDate'));

          // input box
          var start_time = document.createElement("input");
          // you are typing text into the box
          start_time.setAttribute('type', "text");
          // can reference this by using "start_time"
          start_time.setAttribute('name', "start_time");
          start_time.innerHTML = '<input type="text" class="form-control  datepicker" id="datepicker" data-date-format="dd/mm/yyyy" />';

          end_text = document.createElement("span");
          end_text.innerHTML = '<br/>End Time: &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp';
          var end_time = document.createElement("input");
          end_time.setAttribute('type', "test");
          end_time.setAttribute('name', "end_time");

          // if this is -1, there is no repeating event.  Otherwise, the
          // integer value of repeating_event_length will be the number of
          // days
          var repeating_event_length = event.repeating_time_delta; 
          if (repeating_event_length == -1) {
            varRepeatingEvent = clickedNone();
          }
          else if (repeating_event_length == 1) {
            varRepeatingEvent = clickedEveryDay();
          }
          else if (repeating_event_length == 7) {
            varRepeatingEvent = clickedEveryWeek();
          }
          else if (repeating_event_length == 14) {
            varRepeatingEvent = clickedEvery2Weeks();
          }
          else if (repeating_event_length == 28) {
            varRepeatingEvent = clickedEvery4Weeks();
          }

          // I'm leaving this code here because I'm removing it, but if we have time, I could make it functional
/*          var repeatingEvent = document.createElement("button");
          repeatingEvent.className = "btn btn-primary";
          repeatingEvent.setAttribute("data-toggle", "modal");
          repeatingEvent.setAttribute("data-target", ".bs-example-modal-sm");
          repeatingEvent.value = "Repeating Event!!!"
          var textRepeatingEvent = document.createTextNode("Repeating Event");
          repeatingEvent.appendChild(textRepeatingEvent);
          */
          var repeating_text = document.createElement("span");
          repeating_text.innerHTML = varRepeatingEvent;

          var repeatNone = document.getElementById('None');
          repeatNone.onclick = function() {
            repeating_text.innerHTML = "<br/>Event does not repeat";
            repeating_event_length = -1;
            console.log("Click None blah!!!!!");
          };
          var repeatDay = document.getElementById('EveryDay');
          repeatDay.onclick = function() {
            repeating_text.innerHTML = "<br/>Event repeats every day";
            repeating_event_length = 1;
            console.log("Click every day blah!!!!!");
          };
          var repeatWeek = document.getElementById('EveryWeek');
          repeatWeek.onclick = function() {
            repeating_text.innerHTML = "<br/>Event repeats every week";
            repeating_event_length = 7;
            console.log("Click every week blah!!!!!");
          };
          var repeat2Weeks = document.getElementById('Every2Weeks');
          repeat2Weeks.onclick = function() {
            repeating_text.innerHTML = "<br/>Event repeats every two weeks";
            repeating_event_length = 14;
            console.log("Click every 2 weeks blah!!!!!");
          };
          var repeat4Weeks = document.getElementById('Every4Weeks');
          repeat4Weeks.onclick = function() {
            repeating_text.innerHTML = "<br/>Event repeats every four weeks";
            repeating_event_length = 28;
            console.log("Click every 4 weeks blah!!!!!");
          };
          
          var del = document.createElement("button");
          del.className = "btn btn-primary";
          var textDel = document.createTextNode("Delete Event");
          del.appendChild(textDel);
          // if we are editing a repeating event
          if (event.repeating_time_delta != -1) {
            del.setAttribute("data-toggle", "modal");
            del.setAttribute("data-target", ".bs-delete-repeating-events");
            del.value = "Changing repeating Event";
          }
          else {
            del.setAttribute('type',"submit");
          }

          del.onclick = function() {
            console.log("Delete Function");

            if (event.repeating_time_delta == -1) {
              $.ajax({
                type: "POST",
                url: "/calendar/remove_event/",
                data: {"pk": event.id},
                success: function(data) {
                  console.log( "ajax to remove!!!" );
                },
              })
              $('#calendar').fullCalendar('removeEvents', event.id);
              $('#calendar').fullCalendar('rerenderEvents');
              $dialog.dialog('close');
            }
            else {
              var delete_single_event = document.getElementById('DeleteThisEventOnly');
              delete_single_event.onclick = function() {
              // if there is a repeated event before this event, update it so that it no longer has a next_repeated_event.  After doing this, check if it has any previous events; if not, it no longer belongs to a linked list of repeated events, so it should be treated as a non-repeating event
              prev_event = $('#calendar').fullCalendar('clientEvents', event.prev_repeated_event);
              if (prev_event.length != 0) {
                prev_event[0].next_repeated_event = -1;
                if (prev_event[0].prev_repeated_event == -1)
                  prev_event[0].repeating_time_delta = -1;
              }
              $.ajax({
                type: "POST",
                url: "/calendar/remove_event/",
                data: {"pk": event.id},
                success: function(data) {
                  console.log( "ajax to remove!!!" );
                },
              })

              makeRepeatingEventNonRepeating(event);




              $('#calendar').fullCalendar('removeEvents', event.id);
              $('#calendar').fullCalendar('rerenderEvents');
              $dialog.dialog('close');
            };
            var delete_repeating_events = document.getElementById('DeleteRepeatingEvents');
            delete_repeating_events.onclick = function() {
   //             repeating_event_length = 14;
   console.log("Click delete repeating events!!!!!");

   deleteRepeatingEventsFunction(event);



   $dialog.dialog('close');
 };
 var cancel_delete_repeating_events = document.getElementById('CancelDeleteRepeatingEvents');
 cancel_delete_repeating_events.onclick = function() {
  console.log("Click cancel delete in repeating events!!!!!");
};
}
};

$dialog.empty().append(activity_text);
$dialog.append(activity);
$dialog.append(location_text);
$dialog.append(location);

$dialog.append(date_text);
$dialog.append(startDate);
$dialog.append(startTime);

$dialog.append(to_text);

$dialog.append(endDate);
$dialog.append(endTime);
$dialog.append(newline);

// code is commented out above for this, but I could potentially implement this if there is time
//$dialog.append(repeatingEvent);
$dialog.append(del);

         //////// $dialog.append(startTime);

          // the options that our datepicker will use
          var datePickerOptions = {
            autoclose: true,
            todayBtn: true,
            todayHighlight: true

              // make this value the selected date so they can't have something start on one day and end on a later day
              //startDate:
            };

            $(startTime).timepicker();
            $(endTime).timepicker();

            $(startDate).datepicker(datePickerOptions);
            $(endDate).datepicker(datePickerOptions);

            var cancel = document.createElement("button");
          // this makes the Cancel button look nice
          cancel.className = "btn btn-primary";
          cancel.setAttribute('type', "submit");
          var textCancel = document.createTextNode("Cancel");
          cancel.appendChild(textCancel);

          cancel.onclick = function() {
            $dialog.dialog('close');
          };

          var submit = document.createElement("button");
          submit.className = "btn btn-primary";
          var textSubmit = document.createTextNode("Submit");
          submit.appendChild(textSubmit);

          // if we are editing a repeating event
          if (event.repeating_time_delta != -1) {
            submit.setAttribute("data-toggle", "modal");
            submit.setAttribute("data-target", ".bs-edit-repeating-events");
            submit.value = "Editing repeating Event";
          }
          else {
            submit.setAttribute('type', "submit");
          }

          submit.onclick = function() {
            console.log("CLICKED SUBMIT IN EVENT");


            console.log("repeating_event_length = " + repeating_event_length);

            if (repeating_event_length == -1) {

              $.ajax({
                type: "POST",
                url: "/calendar/edit_event/",
                data: {'activity': $('#activity_field').val(),
                'location': $('#location_field').val(),
                'pk': event.id,
                'start_date': $('#txtStartDate').val(),
                'end_date': $('#txtEndDate').val(),
                'start_time': $('#txtStartTime').val(),
                'end_time': $('#txtEndTime').val(),
              // if this is -1, then we don't have a repeating length, otherwise its value is the number of days between repeated events
              'repeating_event_length': repeating_event_length
            },
                    // data is what the server returns
                    success: function(data) {
                        // data[0] now holds the event to add
                        var data = JSON.parse(data);

                        console.log(data);

                        // get the day, month, and year for the start and end dates
                        var start_year = data[0].fields.start_time.substring(0,4);
                        var start_month = data[0].fields.start_time.substring(5,7);
                        var start_day = data[0].fields.start_time.substring(8,10);
                        var start_hour = data[0].fields.start_time.substring(11,13);
                        var start_minute = data[0].fields.start_time.substring(14,16);
                        var start_second = data[0].fields.start_time.substring(17,19);

                        var end_year = data[0].fields.end_time.substring(0,4);
                        var end_month = data[0].fields.end_time.substring(5,7);
                        var end_day = data[0].fields.end_time.substring(8, 10);
                        var end_hour = data[0].fields.end_time.substring(11,13);
                        var end_minute = data[0].fields.end_time.substring(14,16);
                        var end_second = data[0].fields.end_time.substring(17,19);

                        var firstDate = new Date(start_year, start_month, start_day, start_hour, start_minute, start_second, 0);
                        var secondDate = new Date(end_year, end_month, end_day, end_hour, end_minute, end_second, 0);

                        // don't add the event if the dates aren't chronological
                        if (firstDate >= secondDate) {
                          alert("Your event's start date must occur before its end date.");
                        }
                        else {
                          $('#calendar').fullCalendar('removeEvents', event.id);
                          $('#calendar').fullCalendar('rerenderEvents');


                          for (var i = 0; i < data.length; i++) {
                            var added_event = make_events(data, 'blue', ['{{username}}'], false, true)[i];
                            $('#calendar').fullCalendar('renderEvent', added_event, stick = true);
                          }
                          $dialog.dialog('close');
                        }

                      },
                    })
prev_event = $('#calendar').fullCalendar('clientEvents', event.prev_repeated_event);
next_event = $('#calendar').fullCalendar('clientEvents', event.next_repeated_event);


}
else {
  var edit_single_event = document.getElementById('EditThisEventOnly');
  edit_single_event.onclick = function() {
    $.ajax({
      type: "POST",
      url: "/calendar/edit_event/",
      data: {"pk": event.id,
      'activity': $('#activity_field').val(),
      'location': $('#location_field').val(),
      'pk': event.id,
      'start_date': $('#txtStartDate').val(),
      'end_date': $('#txtEndDate').val(),
      'start_time': $('#txtStartTime').val(),
      'end_time': $('#txtEndTime').val(),
            // if this is -1, then we don't have a repeating length, otherwise its value is the number of days between repeated events
            'repeating_event_length': repeating_event_length
          },
          success: function(data) {

                        // data[0] now holds the event to add
                        var data = JSON.parse(data);

                        console.log(data);

                        // get the day, month, and year for the start and end dates
                        var start_year = data[0].fields.start_time.substring(0,4);
                        var start_month = data[0].fields.start_time.substring(5,7);
                        var start_day = data[0].fields.start_time.substring(8,10);
                        var start_hour = data[0].fields.start_time.substring(11,13);
                        var start_minute = data[0].fields.start_time.substring(14,16);
                        var start_second = data[0].fields.start_time.substring(17,19);

                        var end_year = data[0].fields.end_time.substring(0,4);
                        var end_month = data[0].fields.end_time.substring(5,7);
                        var end_day = data[0].fields.end_time.substring(8, 10);
                        var end_hour = data[0].fields.end_time.substring(11,13);
                        var end_minute = data[0].fields.end_time.substring(14,16);
                        var end_second = data[0].fields.end_time.substring(17,19);

                        var firstDate = new Date(start_year, start_month, start_day, start_hour, start_minute, start_second, 0);
                        var secondDate = new Date(end_year, end_month, end_day, end_hour, end_minute, end_second, 0);

                        console.log("firstDate >= secondDate: " + (firstDate >= secondDate));


                        // don't add the event if the dates aren't chronological
                        if (firstDate >= secondDate) {
                          alert("Your event's start date must occur before its end date.");
                        }
                        else {
                          $('#calendar').fullCalendar('removeEvents', event.id);
                          $('#calendar').fullCalendar('rerenderEvents');


                          for (var i = 0; i < data.length; i++) {
                            var editted_event = make_events(data, 'blue', '{{username}}', false, true)[i];
                            $('#calendar').fullCalendar('renderEvent', editted_event, stick = true);
                          }
                          $dialog.dialog('close');

                          makeRepeatingEventNonRepeating(event);
                          event.prev_repeated_event = data[0].fields.prev_repeated_event;
                          event.next_repeated_event = data[0].fields.next_repeated_event;

                          console.log("event = " + event);
                          console.log(event.prev_repeated_event);

                          $dialog.dialog('close');
                        }
                      },
                    })
};



var edit_repeating_events = document.getElementById('EditRepeatingEvents');
edit_repeating_events.onclick = function() {

  console.log("repeating_event_length = " + repeating_event_length);

   //             repeating_event_length = 14;
   console.log("Click edit repeating events!!!!!");
   $.ajax({
    type: "POST",
    url: "/calendar/edit_repeating_events/",
    data: {'activity': $('#activity_field').val(),
    'location': $('#location_field').val(),
    'pk': event.id,
    'start_date': $('#txtStartDate').val(),
    'end_date': $('#txtEndDate').val(),
    'start_time': $('#txtStartTime').val(),
    'end_time': $('#txtEndTime').val(),
              // if this is -1, then we don't have a repeating length, otherwise its value is the number of days between repeated events
              'repeating_event_length': repeating_event_length
            },
                    // data is what the server returns
                    success: function(data) {
                        // data[0] now holds the event to add
                        var data = JSON.parse(data);

                        console.log(data);

                        // get the day, month, and year for the start and end dates
                        var start_year = data[0].fields.start_time.substring(0,4);
                        var start_month = data[0].fields.start_time.substring(5,7);
                        var start_day = data[0].fields.start_time.substring(8,10);
                        var start_hour = data[0].fields.start_time.substring(11,13);
                        var start_minute = data[0].fields.start_time.substring(14,16);
                        var start_second = data[0].fields.start_time.substring(17,19);

                        var end_year = data[0].fields.end_time.substring(0,4);
                        var end_month = data[0].fields.end_time.substring(5,7);
                        var end_day = data[0].fields.end_time.substring(8, 10);
                        var end_hour = data[0].fields.end_time.substring(11,13);
                        var end_minute = data[0].fields.end_time.substring(14,16);
                        var end_second = data[0].fields.end_time.substring(17,19);

                        var firstDate = new Date(start_year, start_month, start_day, start_hour, start_minute, start_second, 0);
                        var secondDate = new Date(end_year, end_month, end_day, end_hour, end_minute, end_second, 0);

                        // don't add the event if the dates aren't chronological
                        if (firstDate >= secondDate) {
                          alert("Your event's start date must occur before its end date.");
                        }
                        else {




                          // if there is a repeated event before this event, update it so that it no longer has a next_repeated_event
                          prev_event = $('#calendar').fullCalendar('clientEvents', event.prev_repeated_event);

                          if (prev_event.length != 0)
                            prev_event[0].next_repeated_event = -1;

                          temp_event = event;

                          while (temp_event.next_repeated_event != -1) {
                            prev_event = temp_event;
                            temp_event = $('#calendar').fullCalendar('clientEvents', prev_event.next_repeated_event)[0];
                            $('#calendar').fullCalendar('removeEvents', prev_event.id);
                            $('#calendar').fullCalendar('rerenderEvents');



                          }
                          $('#calendar').fullCalendar('removeEvents', temp_event.id);
                          $('#calendar').fullCalendar('rerenderEvents');





                          console.log("SHOULDGETHERE!!!");

                          for (var i = 0; i < data.length; i++) {

                            var editted_event = make_events(data, 'blue', '{{username}}', false, true)[i];
                            $('#calendar').fullCalendar('renderEvent', editted_event, stick = true);
                          }
                          $dialog.dialog('close');



                        }

                      },
                    })



  /*              prev_event = $('#calendar').fullCalendar('clientEvents', event.prev_repeated_event);
                next_event = $('#calendar').fullCalendar('clientEvents', event.next_repeated_event);
                */


      //   $dialog.dialog('close');
    };
    var cancel_edit_repeating_events = document.getElementById('CancelEditRepeatingEvents');

  };
};


$dialog.append(cancel);
$dialog.append(submit);
$dialog.append(repeating_text);
$dialog.dialog('open');
}
       // };
      //}

      var del = document.createElement("button");
      del.className = "btn btn-primary";
      del.setAttribute('type',"submit");
      var textDel = document.createTextNode("Delete Event");
      del.appendChild(textDel);

      del.onclick = function() {
          // THE COMMENTED LINE BELOW ASKS IF YOU ARE SURE YOU WANT TO DELETE
          // THE EVENT
    //////      if( confirm( "Are you sure you want to delete event " + event.title + " ?")) {
      console.log("Delete Function");
      $.ajax({
        type: "POST",
        url: "/calendar/remove_event/",
        data: {"pk": event.id},
        success: function(data) {
          console.log( "ajax to remove!!!" );

                  // IF EVENT!!!! IS AN EVENT, IT WILL POPULATE THE CALENDAR IMMEDIATELY
                  /////$('#calendar').fullCalendar('renderEvent', EVENT!!!!)
                },
              })
      $('#calendar').fullCalendar('removeEvents', function (our_event) {
        if (our_event.id == event.id) {
          if (our_event.is_event == event.is_event) {
            return true;
          }
        }
        return false;
      });
      $('#calendar').fullCalendar('rerenderEvents');

      $dialog.dialog('close');
    ///////      }
  };

  $($dialog).empty().append(
    $('<p />').text(event.start.toDateString())
    );
  $($dialog).append(
    $('<p />').text(event.allDay ? 'All day event' : getTime(event.start) + '-' + getTime(event.end))
    );
  if (event.location)
    $($dialog).append(
      $('<p />').text(event.allDay ? 'All day event' : getTime(event.start) + '-' + getTime(event.end))
      );
  
  var owners_list;
  $.ajax({
    type: "GET",
    url: "/calendar/get_event_owners/",
    async: false,
    data: {
      "pk": event.id,
      "type": true,
    },
    success: function(data) {
      owners_list = JSON.parse(data);
    }
  });

  if (owners_list.length > 0) {
    var party_text = "";
    for (var k = 0; k < owners_list.length; k++) {
      if (owners_list[k].fields.username != '{{ username }}')
        party_text = party_text + ", " + owners_list[k].fields.first_name + " " + owners_list[k].fields.last_name;
    }
    $($dialog).append(
      $('<p />').text("Participants: Me" + party_text)
      );
  }
  
  var invite_list = who_is_invited(event.id);
  if (invite_list.length > 0) {
    var invite_text = "";
    for (var k = 0; k < invite_list.length; k++) {
      invite_text = invite_text + ", " + invite_list[k].fields.first_name + " " + invite_list[k].fields.last_name;
    }
    $($dialog).append(
      $('<p />').text("Invited: Me" + invite_text)
      );
  }
  else {
    $($dialog).append(
      $('<p />').text("Invited: No one")
      );
  }

  var del = document.createElement("button");
  del.className = "btn btn-primary";
  var textDel = document.createTextNode("Delete Event");
  del.appendChild(textDel);
        // if we are editing a repeating event
        if (event.repeating_time_delta != -1) {
          del.setAttribute("data-toggle", "modal");
          del.setAttribute("data-target", ".bs-delete-repeating-events");
          del.value = "Changing repeating Event";
        }
        else {
          del.setAttribute('type',"submit");
        }

        del.onclick = function() {
          // THE COMMENTED LINE BELOW ASKS IF YOU ARE SURE YOU WANT TO DELETE
          // THE EVENT
    //////      if( confirm( "Are you sure you want to delete event " + event.title + " ?")) {
      console.log("Delete Function123");

      if (event.repeating_time_delta == -1) {
        $.ajax({
          type: "POST",
          url: "/calendar/remove_event/",
          data: {"pk": event.id},
          success: function(data) {
            console.log( "ajax to remove!!!" );
          },
        })
        $('#calendar').fullCalendar('removeEvents', event.id);
        $('#calendar').fullCalendar('rerenderEvents');
        $dialog.dialog('close');
      }
      else {
        var delete_single_event = document.getElementById('DeleteThisEventOnly');
        delete_single_event.onclick = function() {
          $.ajax({
            type: "POST",
            url: "/calendar/remove_event/",
            data: {"pk": event.id},
            success: function(data) {
              console.log( "ajax to remove!!!" );
            },
          })

          prev_event = $('#calendar').fullCalendar('clientEvents', event.prev_repeated_event);
          next_event = $('#calendar').fullCalendar('clientEvents', event.next_repeated_event);

          if (prev_event.length != 0) {
            if (next_event.length != 0) {
              // if we are deleting an event between two repeated events, point those repeated events to each other
              prev_event[0].next_repeated_event = event.next_repeated_event;
              next_event[0].prev_repeated_event = event.prev_repeated_event;
            }
            else {
              // if we are deleting an event at the end of a list of repeated events, make the second to last event point to nothing (make it the last event)
              prev_event[0].next_repeated_event = -1;
              // if the previous event has no previous event, it is no longer part
              // of a linked list of repeating events, so mark it as such
              if (prev_event[0].prev_repeated_event == -1) {
                prev_event[0].repeating_time_delta = -1;
              }
            }
          }
          else if (next_event.length != 0) {
            // if we are deleting the first event in a list of repeated events, make the second event have no previous event (make it the first event)
            next_event[0].prev_repeated_event = -1;
            // if the next event has no next event, it is no longer part of a
            // linked list of repeating events, so mark it as such
            if (next_event[0].next_repeated_event == -1) {
              next_event[0].repeating_time_delta = -1;
            }
          }

          $('#calendar').fullCalendar('removeEvents', event.id);
          $('#calendar').fullCalendar('rerenderEvents');
          $dialog.dialog('close');
        };
        var delete_repeating_events = document.getElementById('DeleteRepeatingEvents');
        delete_repeating_events.onclick = function() {
//             repeating_event_length = 14;
console.log("Click delete repeating events!!!!!");

deleteRepeatingEventsFunction(event);



$dialog.dialog('close');
};
var cancel_delete_repeating_events = document.getElementById('CancelDeleteRepeatingEvents');
cancel_delete_repeating_events.onclick = function() {
  console.log("Click cancel delete in repeating events!!!!!");




};

          ////////    $('#calendar').fullCalendar('removeEvents', event.id);
          ////////    $('#calendar').fullCalendar('rerenderEvents');



        }




    ///////      }
  };

  var cancel = document.createElement("button");
  cancel.className = "btn btn-primary";
  cancel.setAttribute('type', "submit");
  var textCancel = document.createTextNode("Cancel");
  cancel.appendChild(textCancel);

  cancel.onclick = function() {
    $dialog.dialog('close');
  };

  $dialog.append(cancel);
  $($dialog).append(edit);
  $($dialog).append(party);
  $($dialog).append(del);
  $dialog.dialog('open');
}
      // edit downtimes
      else {

        able = false;
        for (var k = 0; k < event.owners.length; k++) {
          if (event.owners[k] == '{{ username }}') able = true;
        }
        if (able) {

          $dialog.dialog({title:event.title});
          var suggest = document.createElement("input");
          suggest.className = "btn btn-primary";
          suggest.setAttribute('type', "submit");
          suggest.setAttribute('value', "Suggest");
          suggest.onclick = function() {
            $.ajax({
              type: "GET",
              url: "/calendar/suggest/",
              data: {'pk': event.id},
              success: function(data) {
            // Make the unconfirmed event show up in your calendar
            if (data === "None") {
              alert("You have no upcoming downtimes.")
            }
            else {
              if (data == "NoFriends") {
                alert("You have no friends.")
              }
              else {
                if (data == "NoMatch") {
                  alert("No free times align")
                }
                else {
                  var r = confirm("Send Request?");
                  // if user clicked Okay:
                  if (r == true) {
                    // send the other user a request:
                    //************** SEND EVENT NOTIFICATION *******************//
                    var alldata = JSON.parse(data);
                    console.log(alldata);
                    mydata = [];
                    var friends = [];
                    for (var i = 0; i < alldata.length; i++) {
                      if (alldata[i].model == "udCalendar.updoguser") {
                        friends.push(alldata[i].pk);
                      }

                      else {
                        mydata.push(alldata[i]);
                      }
                    }
                    $.ajax({
                      type: "POST",
                      url: "/calendar/send_event_notifications/",
                      data: {
                        "event": mydata[0].pk,
                        "to_users": JSON.stringify(friends),
                        "data_type": "pk",
                      },
                      success: function(data) {

                        console.log(data);
                      }
                    });

                    //************** SEND EVENT NOTIFICATION *******************//

                    // display the unconfirmed event on the initiator's calendar
                    var unconf = make_events(mydata, 'orange', '{{ username }}', false, true);
                    $("#calendar").fullCalendar('renderEvent', unconf[0], stick=true);
                  }
                  // if user clicked Cancel:
                  else {
                    // remove the unconfirmed event from the back end
                    $.ajax({
                      type: "POST",
                      url: "/calendar/remove_event/",
                      data: {"pk": JSON.parse(data)[0].pk},
                    });
                  }
                }
              }
            }
          }
        });
$dialog.dialog('close');
};

var edit = document.createElement("button");
edit.className = "btn btn-primary";
edit.setAttribute('type', "submit");
var textEdit = document.createTextNode("Edit Downtime");
edit.appendChild(textEdit);
edit.setAttribute('value', "Edit Downtime");

edit.onclick = function() {

  $dialog.dialog('close');
  $dialog.dialog({title:'Edit Downtime'});

  var activity_text = document.createElement("span");
  activity_text.innerHTML = 'Preferred Activity: &nbsp';
  var activity = document.createElement("input");
  activity.setAttribute('type', "text");
  activity.setAttribute('name', "activity");
  activity.setAttribute('id', 'activity_field'); 

  if (event.title != "{{username}} is free") {

    var nameLength = "{{username}}".length;
    activity.setAttribute("value", event.title.substring(nameLength + 25, event.title.length));
  }

          // span makes it so there's no newline at the end, while "br" would
          // include the newline
          start_text = document.createElement("span");
          // &nbsp is a non-breaking whitespace character
          start_text.innerHTML = '<br/>Start Time: &nbsp&nbsp&nbsp&nbsp&nbsp';
          // input box
          var start_time = document.createElement("input");
          // you are typing text into the box
          start_time.setAttribute('type', "text");
          // can reference this by using "start_time"
          start_time.setAttribute('name', "start_time");
          start_time.setAttribute('id', 'st_field');
          end_text = document.createElement("span");
          end_text.innerHTML = '<br/>End Time: &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp';
          var end_time = document.createElement("input");
          end_time.setAttribute('type', "test");
          end_time.setAttribute('name', "end_time");
          end_time.setAttribute('id', 'et_field');

          var newline = document.createElement("span");
          newline.innerHTML = '<br/>';

          $dialog.empty().append(activity_text);
          $dialog.append(activity);
          $dialog.append(start_text);
          $dialog.append(start_time);
          $dialog.append(end_text);
          $dialog.append(end_time);
          $dialog.append(newline);

          var cancel = document.createElement("button");
          // this makes the Cancel button look nice
          cancel.className = "btn btn-primary";
          cancel.setAttribute('type', "submit");
          var textCancel = document.createTextNode("Cancel");
          cancel.appendChild(textCancel);

          cancel.onclick = function() {
            $dialog.dialog('close');
          };

          // this button will make an existing downtime into an event
      /*    var make_downtime_event = document.createElement("button");
          make_downtime_event.className = "btn btn-primary";
          make_downtime_event.setAttribute*/



          var submit = document.createElement("button");
          submit.className = "btn btn-primary";
          submit.setAttribute('type',"submit");
          var textSubmit = document.createTextNode("Submit");
          submit.appendChild(textSubmit);

          submit.onclick = function() {

            $.ajax({
              type: "POST",
              url: "/calendar/edit_downtime/",
              data: {'activity': $('#activity_field').val(),
              'pk': event.id,
              'starttime': $('#st_field').val(),
              'endtime': $('#et_field').val(),

            },
            success: function(data) {

              parsed = JSON.parse(data);
              if ($('#activity_field').val().length == 0) {
                event.title = event.title.split(" ")[0] + ' is free';
              }
              else {
                event.title = event.title.split(" ")[0] + "'s preferred activity: \n" + $('#activity_field').val();
              }

              $("#calendar").fullCalendar('renderEvent', event, stick=true);
              if (parsed.length > 1) {
                event.start = parsed[0].fields.start_time;
                event.end = parsed[0].fields.end_time;
                $("#calendar").fullCalendar('renderEvent', event, stick=true);
                for (var i = 0; i < parsed.length; i++) {
                  if (parsed[i].pk != -event.id) { // **********
                    $('#calendar').fullCalendar('removeEvents', -parsed[i].pk); // ***********
                  }
                }
              }
              else {
                if (parsed.length == 1) {
                  $('#calendar').fullCalendar('removeEvents', -parsed[0].pk); // changed to negative 11:25 pm
                }
              }
              if (parsed.length != 0) {
                $('#calendar').fullCalendar('rerenderEvents'); 
              }
              $dialog.dialog('close');
            },


          });
};

$dialog.append(cancel);
$dialog.append(submit);
$dialog.dialog('open');
};

var del = document.createElement("button");
del.className = "btn btn-primary";
del.setAttribute('type',"submit");
var textDel = document.createTextNode("Delete Downtime");
del.appendChild(textDel);
del.setAttribute('value', "Delete Downtime");

del.onclick = function() {
          // THE COMMENTED OUT LINE BELOW ASKS IF YOU ARE SURE YOU WANT
          // TO DELETE AN EVENT
        ///////  if( confirm( "Are you sure you want to delete this downtime?")) {
            //console.log("Delete Function");
            $.ajax({
              type: "POST",
              url: "/calendar/remove_downtime/",
              data: {"pk": event.id},
              success: function(data) {
                  //console.log( "ajax to remove!!!" );

                  // IF EVENT!!!! IS AN EVENT, IT WILL POPULATE THE CALENDAR IMMEDIATELY
                  /////$('#calendar').fullCalendar('renderEvent', EVENT!!!!)
                },
              });

            $('#calendar').fullCalendar('removeEvents', function (our_event) {
              if (our_event.id == event.id) {
                if (our_event.is_event == event.is_event) {
                  return true;
                }
              }
              return false;
            });
            $('#calendar').fullCalendar('rerenderEvents');
            
            $dialog.dialog('close');
   //////       }
 };

 $($dialog).empty().append(
  $('<p />').text(event.start.toDateString())
  );
 $($dialog).append(
  $('<p />').text(event.allDay ? 'All day event' : getTime(event.start) + '-' + getTime(event.end))
  );
 if (event.location)
  $($dialog).append(
    $('<p />').text(event.allDay ? 'All day event' : getTime(event.start) + '-' + getTime(event.end))
    );

var cancel = document.createElement("button");
        // this makes the Cancel button look nice
        cancel.className = "btn btn-primary";
        cancel.setAttribute('type', "submit");
        var textCancel = document.createTextNode("Cancel");
        cancel.appendChild(textCancel);

        cancel.onclick = function() {
          $dialog.dialog('close');
        };

        $dialog.append(cancel);
        $($dialog).append(edit);
        $($dialog).append(del);
        $dialog.dialog('open');
        $dialog.append(suggest);
      }
    }
  };
},
  //  }
//    },
eventDrop: function(event,dayDelta,minuteDelta,revertFunc) {
      // make sure a dropped event is no longer part of a linked list
      // of repeating events
      if (event.prev_repeated_event != -1) {
        prev_event = $('#calendar').fullCalendar('clientEvents', event.prev_repeated_event)[0];
        prev_event.next_repeated_event = event.next_repeated_event;
      }
      if (event.next_repeated_event != -1) {
        next_event = $('#calendar').fullCalendar('clientEvents', event.next_repeated_event)[0];
        next_event.prev_repeated_event = event.prev_repeated_event;
      }
      event.repeating_time_delta = -1;
      event.prev_repeated_event = -1;
      event.next_repeated_event = -1;

      if (event.is_event) {

        $.ajax({
          type: "POST",
          url: "/calendar/change_event/",
          data: {"pk": event.id, 
          "day_delta": dayDelta,
          "minute_delta": minuteDelta,
          "resize": "false",
        },
        success: function(data) {
          console.log(data);

          var parsed = JSON.parse(data);
          resolve_event_downtime_conflicts(parsed);

          //console.log("event.id = " + event.id);


        }
      });
      }
      // if event is a downtime
      else {
        $.ajax({
          type: "POST",
          url: "/calendar/change_downtime/",
          data: {"pk": event.id, 
          "day_delta": dayDelta,
          "minute_delta": minuteDelta,
          "resize": "false",
        },
        success: function(data) {

          parsed = JSON.parse(data);
          if (parsed.length > 1) {
            event.start = parsed[0].fields.start_time;
            event.end = parsed[0].fields.end_time;
            $("#calendar").fullCalendar('renderEvent', event, stick=true);
            for (var i = 0; i < parsed.length; i++) {
              if (parsed[i].pk != -event.id && parsed[i].model == "udCalendar.downtime") {
                $('#calendar').fullCalendar('removeEvents', -parsed[i].pk);
              }
            }
          }
          else {
            if (parsed.length == 1) {
              $('#calendar').fullCalendar('removeEvents', -parsed[0].pk); // changed to negative 11:20 pm
            }
          }
          if (parsed.length != 0) {
            $('#calendar').fullCalendar('rerenderEvents'); 
          }


          console.log("event.id = " + event.id);

          if ($('#calendar').fullCalendar('clientEvents', event.id).length > 0) {
            $.ajax({
              type: "POST",
              url: "/calendar/event_conflicts/",
              data: {"pk": -event.id,
              "day_delta": dayDelta,
              "minute_delta": minuteDelta,
              "resize": "false",
            },
            success: function(data) {
              var parsed = JSON.parse(data);

              console.log("parsed:");
              console.log(parsed);

              resolve_event_downtime_conflicts(parsed);

               /* $('#calendar').fullCalendar('removeEvents', event.id);
               $('#calendar').fullCalendar('rerenderEvents');*/
             },
           });


/*

          $.ajax({
              type: "POST",
              url: "/calendar/event_conflicts/",
              data: {"pk": -event.id, 
              "resize": "true",
            },
            success: function(data) {
              console.log("HERE!!!!!!!!!!!")
              var new_downtimes = JSON.parse(data);
              console.log("new_downtimes = ");
              console.log(new_downtimes);
              resolve_event_downtime_conflicts(new_downtimes);
            },
          });

*/










}

},
});
}
},
eventResize: function(event,dayDelta,minuteDelta,revertFunc) {
  var view = $('#calendar').fullCalendar('getView');
  if (view.name != 'month') {
      // make sure a resized event is no longer part of a linked list
      // of repeating events
      if (event.prev_repeated_event != -1) {
        prev_event = $('#calendar').fullCalendar('clientEvents', event.prev_repeated_event)[0];
        prev_event.next_repeated_event = event.next_repeated_event;
      }
      if (event.next_repeated_event != -1) {
        next_event = $('#calendar').fullCalendar('clientEvents', event.next_repeated_event)[0];
        next_event.prev_repeated_event = event.prev_repeated_event;
      }
      event.repeating_time_delta = -1
      event.prev_repeated_event = -1
      event.next_repeated_event = -1

      if (event.is_event) {
        $.ajax({
          type: "POST",
          url: "/calendar/change_event/",
          data: {"pk": event.id, 
          "day_delta": dayDelta,
          "minute_delta": minuteDelta,
          "resize": "true",
        },
        success: function(data) {
          var parsed = JSON.parse(data);
          resolve_event_downtime_conflicts(parsed);
        }
      });
      }

      else {
        $.ajax({
          type: "POST",
          url: "/calendar/change_downtime/",
          data: {"pk": event.id, 
          "day_delta": dayDelta,
          "minute_delta": minuteDelta,
          "resize": "true",
        },
        success: function(data) {
          parsed = JSON.parse(data);
          if (parsed.length > 1) {
            event.start = parsed[0].fields.start_time;
            event.end = parsed[0].fields.end_time;
            $("#calendar").fullCalendar('renderEvent', event, stick=true);
            for (var i = 0; i < parsed.length; i++) {
              if (parsed[i].pk != -event.id) {
            $('#calendar').fullCalendar('removeEvents', -parsed[i].pk); // made this negative 11:11 PM
          }
        }
      }
      else {
        if (parsed.length == 1) {
          if (parsed[0].model == "udCalendar.downtime") {
            $('#calendar').fullCalendar('removeEvents', -parsed[0].pk);
          }
        }
      }
      if (parsed.length != 0) {
        $('#calendar').fullCalendar('rerenderEvents'); 
      }

      $.ajax({
        type: "POST",
        url: "/calendar/event_conflicts/",
        data: {"pk": -event.id, 
        "resize": "true",
      },
      success: function(data) {
        console.log("HERE!!!!!!!!!!!")
        var new_downtimes = JSON.parse(data);
        resolve_event_downtime_conflicts(new_downtimes);
      },
    });
    },        
  });
}


}
},

select: function(startDate, endDate, allDay, jsEvent, view) {
  if (view.name != 'month') {
    if (startDate - endDate == -1800000) return;

    startDateOffset = startDate.getTimezoneOffset();
    startDate = new Date(startDate.getTime() - startDateOffset*60000);
    endDate = new Date(endDate.getTime() - startDateOffset*60000);

    $.ajax({
      type:"POST",
      url: "/calendar/add_downtime/",
      data: {"startDate": startDate.toUTCString(),
      "endDate": endDate.toUTCString(),
      "allDay": allDay,
    },
    success: function(data) {
      parsed = JSON.parse(data)
      if (parsed.length > 0) {
        if (parsed.length > 1) {
          if (parsed[1].pk != parsed[0].pk) {
            var displayed_downtime = make_events([parsed[0]], 'green', "{{ username }}", false, false);
            $("#calendar").fullCalendar('renderEvent', displayed_downtime[0], stick=true);
            for (var i = 1; i < parsed.length; i++) {
              $('#calendar').fullCalendar('removeEvents', -parsed[i].pk);
            }
            $('#calendar').fullCalendar('rerenderEvents');
          }
        }
        else {
          var displayed_downtime = make_events(parsed, 'green', "{{ username }}", false, false);

          $("#calendar").fullCalendar('renderEvent', displayed_downtime[0], stick=true);
        }
      }
      $.ajax({
        type: "POST",
        url: "/calendar/event_conflicts/",
        data: {"pk": -displayed_downtime[0].id,
        "resize": "true",
      },
      success: function(data) {
        var parsed = JSON.parse(data);

        console.log("parsed:");
        console.log(parsed);

        resolve_event_downtime_conflicts(parsed);
      },
    });
    },         
  })
}
},

dayClick:function( date, allDay, jsEvent, view ) {
  if (view.name != 'month') {
    var singleClick = date.toUTCString();
            // double click
            if(doubleClick==singleClick){
              console.log('Double-click!');
              doubleClick = null;

              $dialog.dialog(
              {
                title:'Add Event',
                width: 500,
                height: 215
              }
              );

                // dialog box's activity text
                var activity_text = document.createElement("span");
                activity_text.innerHTML = 'Activity (opt): &nbsp';
                // dialog box's activity input field
                var activity = document.createElement("input");
                activity.setAttribute('type', "text");
                activity.setAttribute('name', "activity");
                activity.setAttribute('id', 'activity_field'); 
                // dialog box's location input field
                var location_text = document.createElement("span");
                location_text.innerHTML = '<br/>Location (opt): ';
                var location = document.createElement("input");
                location.setAttribute('type', "text");
                location.setAttribute('name', "location");
                location.setAttribute('id', 'location_field'); 
                // dialog box's startTime input field
                var startTime = document.createElement("input");
                startTime.id = "txtStartTime";
                startTime.type = "text";
                startTime.className = 'input-small';
                startTime.style.width = "85px";
                // dialog box's endTime input field
                var endTime = document.createElement("input");
                endTime.id = "txtEndTime";
                endTime.type = "text";
                endTime.className = 'input-small';
                endTime.style.width = "85px";
                // is the time in the morning (AM) or afternoon (PM)
                var start_am_pm = "PM";
                var startHour = date.getHours();
                if (startHour == 0) {
                  startHour = 12;
                  start_am_pm = "AM";
                }
                else if (startHour < 12) {
                  start_am_pm = "AM";
                }
                // if the time is PM, don't use military time (eg. 13:00 ==> 1:00)
                else if (startHour != 12) {
                  startHour = startHour - 12;
                }
                var startMinute = date.getMinutes();
                // set the initial start time to be the time that was clicked to make the event
                startTime.setAttribute('value', startHour + ':' + startMinute + ' ' + start_am_pm);

                // increment the initial end time to be one hour (3.6e6 milliseconds) later than the initial start time
                var endDateObject = new Date();
                endDateObject.setTime(date.getTime() + (60*60*1000));
                var end_am_pm = "PM";
                var endHour = endDateObject.getHours();
                if (endHour == 0) {
                  endHour = 12;
                  end_am_pm = "AM";
                }
                else if (endHour < 12) {
                  end_am_pm = "AM";
                }
                else if (endHour != 12) {
                  endHour = endHour - 12;
                }
                var endMinute = endDateObject.getMinutes();
                // set the initial start time to be the time that was clicked to make the event
                endTime.setAttribute('value', endHour + ':' + endMinute + ' ' + end_am_pm);

                // the box that holds the startTime timepicker
                var lblStartTime = document.createElement('label')
                lblStartTime.htmlFor = "txtStartTime";
                lblStartTime.appendChild(document.createTextNode('fromTime'));
                // the box that holds the endTime timepicker
                var lblEndTime = document.createElement('label')
                lblEndTime.htmlFor = "txtEndTime";
                lblEndTime.appendChild(document.createTextNode('toTime'));

                var newline = document.createElement("span");
                newline.innerHTML = ' <br/>';

                var startDate = document.createElement("input");
                startDate.id = "txtStartDate";
                startDate.type = "text";
                startDate.className = "datepicker";
                startDate.style.width = "85px";
                startDate.readonly = "readonly";

                // span makes it so there's no newline at the end, while "br" would
                // include the newline
                date_text = document.createElement("span");
                // &nbsp is a non-breaking whitespace character
                date_text.innerHTML = '<br/>Event Dates: ';

                // January is 0 so we add 1
                var startMonth = date.getMonth() + 1;
                if (startMonth < 10) {
                  startMonth = '0' + startMonth;
                }
                var startDay = date.getDate();

                if (startDay < 10) {
                  startDay = '0' + startDay;
                }
                // when editing an event, the start date is displayed
                startDate.setAttribute('value', startMonth + '/' + startDay + '/' + date.getFullYear());

                var lblStartDate = document.createElement('label')
                lblStartDate.htmlFor = "txtStartDate";
                lblStartDate.appendChild(document.createTextNode('fromDate'));

                to_text = document.createElement("span");
                // &nbsp is a non-breaking whitespace character
                to_text.innerHTML = '&nbsp to &nbsp';

                var endDate = document.createElement("input");
                endDate.id = "txtEndDate";
                endDate.type = "text";
                endDate.className = "datepicker";
                endDate.style.width = "85px";
                endDate.readonly = "readonly";

                // January is 0 so we add 1
                var endMonth = endDateObject.getMonth() + 1;
                if (endMonth < 10) {
                  endMonth = '0' + endMonth;
                }
                var endDay = endDateObject.getDate();

                if (endDay < 10) {
                  endDay = '0' + endDay;
                }

                // when editing an event, the end date is displayed
                endDate.setAttribute('value', endMonth + '/' + endDay + '/' + endDateObject.getFullYear());

                var lblEndDate = document.createElement('label');
                lblEndDate.htmlFor = "txtEndDate";
                lblEndDate.appendChild(document.createTextNode('toDate'));

                // if this is -1, there is no repeating event.  Otherwise, the
                // integer value of repeating_event_length will be the number of
                // days
                var repeating_event_length = -1;

                var repeatingEvent = document.createElement("button");
                repeatingEvent.className = "btn btn-primary";
                repeatingEvent.setAttribute("data-toggle", "modal");
                repeatingEvent.setAttribute("data-target", ".bs-example-modal-sm");
                repeatingEvent.value = "Repeating Event!!!"
                var textRepeatingEvent = document.createTextNode("Repeating Event");
                repeatingEvent.appendChild(textRepeatingEvent);

                var repeating_text = document.createElement("span");
                repeating_text.innerHTML = "<br/>Event does not repeat";

                var repeatNone = document.getElementById('None');

                // if we don't have a repeating event, these two values will be -1
                var repeating_end = -1;
                var repeating_end_text = -1;

                function reset_dialog_without_end_repeating($dialog) {
                  $dialog.dialog('close');
                  $dialog.empty().append(activity_text);
                  $dialog.append(activity);

                  $dialog.append(location_text);
                  $dialog.append(location);

                  $dialog.append(date_text)
                  $dialog.append(startDate);
                  $dialog.append(startTime);

                  $dialog.append(to_text);

                  $dialog.append(endDate);
                  $dialog.append(endTime);
                  $dialog.append(newline);

                  $dialog.append(repeatingEvent);

                  $dialog.append(cancel);
                  $dialog.append(submit);

                  $dialog.append(repeating_text);

                  $dialog.dialog('open');
                }

                repeatNone.onclick = function() {
                  repeating_text.innerHTML = "<br/>Event does not repeat";
                  repeating_event_length = -1;
                  console.log("Click None blah!!!!!");

                  repeating_end = -1;
                  repeating_end_text = -1;

                  reset_dialog_without_end_repeating($dialog);

                };

                var repeatDay = document.getElementById('EveryDay');
                repeatDay.onclick = function() {
                  repeating_text.innerHTML = "<br/>Event repeats every day: ";
                  repeating_event_length = 1;
                  console.log("Click every day blah!!!!!");

                  if (repeating_end != 1) {
                    // this input box allows user to specify how many times
                    // their event will repeat
                    repeating_end = document.createElement("input");
                    repeating_end.setAttribute('type', "text");
                    repeating_end.setAttribute('name', "repeating_end");
                    repeating_end.setAttribute('id', 'repeating_end_field'); 
                    repeating_end.setAttribute('size', '2');
                    repeating_end.setAttribute('maxlength', '2');

                    repeating_end_text = document.createElement("span");
                    repeating_end_text.innerHTML = ' times';

                    reset_dialog_without_end_repeating($dialog);

                    $dialog.append(repeating_end);
                    $dialog.append(repeating_end_text);

                    repeating_end = 1;
                  }
                };

                var repeatWeek = document.getElementById('EveryWeek');
                repeatWeek.onclick = function() {
                  repeating_text.innerHTML = "<br/>Event repeats every week: ";
                  repeating_event_length = 7;
                  console.log("Click every week blah!!!!!");

                  if (repeating_end != 1) {
                    // this input box allows user to specify how many times
                    // their event will repeat
                    repeating_end = document.createElement("input");
                    repeating_end.setAttribute('type', "text");
                    repeating_end.setAttribute('name', "repeating_end");
                    repeating_end.setAttribute('id', 'repeating_end_field'); 
                    repeating_end.setAttribute('size', '2');
                    repeating_end.setAttribute('maxlength', '2');

                    repeating_end_text = document.createElement("span");
                    repeating_end_text.innerHTML = ' times';

                    reset_dialog_without_end_repeating($dialog);

                    $dialog.append(repeating_end);
                    $dialog.append(repeating_end_text);

                    repeating_end = 1;
                  }
                };
                var repeat2Weeks = document.getElementById('Every2Weeks');
                repeat2Weeks.onclick = function() {
                  repeating_text.innerHTML = "<br/>Event repeats every two weeks: ";
                  repeating_event_length = 14;
                  console.log("Click every 2 weeks blah!!!!!");

                  if (repeating_end != 1) {
                    // this input box allows user to specify how many times
                    // their event will repeat
                    repeating_end = document.createElement("input");
                    repeating_end.setAttribute('type', "text");
                    repeating_end.setAttribute('name', "repeating_end");
                    repeating_end.setAttribute('id', 'repeating_end_field'); 
                    repeating_end.setAttribute('size', '2');
                    repeating_end.setAttribute('maxlength', '2');

                    repeating_end_text = document.createElement("span");
                    repeating_end_text.innerHTML = ' times';

                    reset_dialog_without_end_repeating($dialog);

                    $dialog.append(repeating_end);
                    $dialog.append(repeating_end_text);

                    repeating_end = 1;
                  }
                };
                var repeat4Weeks = document.getElementById('Every4Weeks');
                repeat4Weeks.onclick = function() {
                  repeating_text.innerHTML = "<br/>Event repeats every four weeks: ";
                  repeating_event_length = 28;
                  console.log("Click every 4 weeks blah!!!!!");

                  if (repeating_end != 1) {
                    // this input box allows user to specify how many times
                    // their event will repeat
                    repeating_end = document.createElement("input");
                    repeating_end.setAttribute('type', "text");
                    repeating_end.setAttribute('name', "repeating_end");
                    repeating_end.setAttribute('id', 'repeating_end_field'); 
                    repeating_end.setAttribute('size', '2');
                    repeating_end.setAttribute('maxlength', '2');

                    repeating_end_text = document.createElement("span");
                    repeating_end_text.innerHTML = ' times';

                    reset_dialog_without_end_repeating($dialog);

                    $dialog.append(repeating_end);
                    $dialog.append(repeating_end_text);

                    repeating_end = 1;
                  }
                };

                $dialog.empty().append(activity_text);
                $dialog.append(activity);

                $dialog.append(location_text);
                $dialog.append(location);

                $dialog.append(date_text)
                $dialog.append(startDate);
                $dialog.append(startTime);

                $dialog.append(to_text);

                $dialog.append(endDate);
                $dialog.append(endTime);
                $dialog.append(newline);

                $dialog.append(repeatingEvent);

                // the options that our datepicker will use
                var datePickerOptions = {
                  autoclose: true,
                  todayBtn: true,
                  todayHighlight: true
                };

                $(startTime).timepicker();
                $(endTime).timepicker();

                $(startDate).datepicker(datePickerOptions);
                $(endDate).datepicker(datePickerOptions);

                var cancel = document.createElement("button");
                // this makes the Cancel button look nice
                cancel.className = "btn btn-primary";
                cancel.setAttribute('type', "submit");
                var textCancel = document.createTextNode("Cancel");
                cancel.appendChild(textCancel);

                cancel.onclick = function() {
                  $dialog.dialog('close');
                };

                var submit = document.createElement("button");
                submit.className = "btn btn-primary";
                submit.setAttribute('type',"submit");
                var textSubmit = document.createTextNode("Submit");
                submit.appendChild(textSubmit);

                submit.onclick = function() {
                  // if we don't have a repeating event
                  if (!$('#repeating_end_field').val()) {
                    var num_repeating_events = -1;
                  }
                  // if we have a repeating event
                  else var num_repeating_events = $('#repeating_end_field').val();

                  // if a "repeating event" doesn't actually repeat, make it a non-repeating event
                  if (num_repeating_events == 1) {
                    num_repeating_events = -1;
                    repeating_event_length = -1;
                  }




                  console.log("num_repeating_events = " + num_repeating_events);


                  if (num_repeating_events != -1) {
                    if (!(num_repeating_events.match(/^([0-9])([0-9]?)$/))) {
                      alert("Event must repeat an integer number of times!");
                    }
                  }

             //   if (num_repeating_events != -1) {
                  // can't have an event that repeats 0 times
                  if (num_repeating_events == 0) {
                    alert("Can't create an event that repeats 0 times!");
                  }
                  // the number of times repeating an event is incorrect
                  else if (num_repeating_events > 15) {
                    alert("Event must repeat 15 times or fewer!");
                  }
                  // if we have a valid input for number of repeating events
                  else {

                    $.ajax({
                      type: "POST",
                      url: "/calendar/add_event/",
                      data: {'activity': $('#activity_field').val(),
                      'location': $('#location_field').val(),
                      'start_date': $('#txtStartDate').val(),
                      'end_date': $('#txtEndDate').val(),
                      'start_time': $('#txtStartTime').val(),
                      'end_time': $('#txtEndTime').val(),
                      // if this is -1, then we don't have a repeating length, otherwise its value is the number of days between repeated events
                      'repeating_event_length': repeating_event_length,
                      // if this is -1, then we don't have a repeating event, otherwise its value is the number of times an event repeats
                      'num_repeating_events': num_repeating_events,
                    },
                      // data is what the server returns
                      success: function(data) {
                        // data[0] now holds the event to add
                        var data = JSON.parse(data);
                        console.log("number repeats = " + num_repeating_events);

                        // this event exists num_repeating_events times
                        if (num_repeating_events != -1) {
                            // get the day, month, and year for the start and end dates
                            var start_year = data[0].fields.start_time.substring(0,4);
                            var start_month = data[0].fields.start_time.substring(5,7);
                            var start_day = data[0].fields.start_time.substring(8,10);
                            var start_hour = data[0].fields.start_time.substring(11,13);
                            var start_minute = data[0].fields.start_time.substring(14,16);
                            var start_second = data[0].fields.start_time.substring(17,19);

                            var end_year = data[0].fields.end_time.substring(0,4);
                            var end_month = data[0].fields.end_time.substring(5,7);
                            var end_day = data[0].fields.end_time.substring(8, 10);
                            var end_hour = data[0].fields.end_time.substring(11,13);
                            var end_minute = data[0].fields.end_time.substring(14,16);
                            var end_second = data[0].fields.end_time.substring(17,19);

                            var firstDate = new Date(start_year, start_month, start_day, start_hour, start_minute, start_second, 0);
                            var secondDate = new Date(end_year, end_month, end_day, end_hour, end_minute, end_second, 0);

                            // don't add the event if the dates aren't chronological
                            if (firstDate >= secondDate) {
                              alert("Your event's start date must occur before its end date.");
                            }
                            else {
                              for (var i = 0; i < data.length; i++) {
                                var added_event = make_events(data, 'blue', '{{username}}', false, true)[i];
                                $('#calendar').fullCalendar('renderEvent', added_event, stick = true);

                        // call change_event to resolve any conflicts with downtimes that might now exist with added_event now that it's been added
                        $.ajax({
                          type: "POST",
                          url: "/calendar/resolve_repeating_conflicts/",
                          data: {"pk": added_event.id, 
                              // day_delta and minute_delta are 0 because we are not actually changing the added event
                              "day_delta": 0,
                              "minute_delta": 0,
                              "resize": "false",
                            },
                            success: function(data) {
                              console.log(data);

                              var parsed = JSON.parse(data);
                              resolve_event_downtime_conflicts(parsed);

                              //console.log("event.id = " + event.id);


                            }
                          });
                      }
                      $dialog.dialog('close');
                    }

                  }
                        // we don't have a repeating event
                        else {
                            // get the day, month, and year for the start and end dates
                            var start_year = data[0].fields.start_time.substring(0,4);
                            var start_month = data[0].fields.start_time.substring(5,7);
                            var start_day = data[0].fields.start_time.substring(8,10);
                            var start_hour = data[0].fields.start_time.substring(11,13);
                            var start_minute = data[0].fields.start_time.substring(14,16);
                            var start_second = data[0].fields.start_time.substring(17,19);

                            var end_year = data[0].fields.end_time.substring(0,4);
                            var end_month = data[0].fields.end_time.substring(5,7);
                            var end_day = data[0].fields.end_time.substring(8, 10);
                            var end_hour = data[0].fields.end_time.substring(11,13);
                            var end_minute = data[0].fields.end_time.substring(14,16);
                            var end_second = data[0].fields.end_time.substring(17,19);

                            var firstDate = new Date(start_year, start_month, start_day, start_hour, start_minute, start_second, 0);
                            var secondDate = new Date(end_year, end_month, end_day, end_hour, end_minute, end_second, 0);

                            // don't add the event if the dates aren't chronological
                            if (firstDate >= secondDate) {
                              alert("Your event's start date must occur before its end date.");
                            }
                            else {
                              for (var i = 0; i < data.length; i++) {
                                var added_event = make_events(data, 'blue', '{{username}}', false, true)[i];
                                $('#calendar').fullCalendar('renderEvent', added_event, stick = true);
                              }
                              $dialog.dialog('close');
                            }
                          }
                        // call change_event to resolve any conflicts with downtimes that might now exist with added_event now that it's been added
                        $.ajax({
                          type: "POST",
                          url: "/calendar/change_event/",
                          data: {"pk": added_event.id, 
                              // day_delta and minute_delta are 0 because we are not actually changing the added event
                              "day_delta": 0,
                              "minute_delta": 0,
                              "resize": "false",
                            },
                            success: function(data) {
                              console.log(data);

                              var parsed = JSON.parse(data);
                              resolve_event_downtime_conflicts(parsed);

                              //console.log("event.id = " + event.id);


                            }
                          });





                      },
                    });
}
};
$dialog.append(cancel);
$dialog.append(submit);
$dialog.append(repeating_text);
$dialog.dialog('open');
}
            // single click
            else{
              doubleClick=date.toUTCString();
              clearInterval(clickTimer);
              clickTimer = setInterval(function(){
                doubleClick = null;
                clearInterval(clickTimer);
              }, 500);
            }
          }
        },
      }
      
      );
});








</script>


<!-- Adjust the style of the modal Repeating Events box.  margin-left of the
 modal should be -(widthOfModal / 2) -->
 <style>
  body .modal.fade.bs-example-modal-sm {
    max-width: 212px;
    margin-left: 40%;
  }
  body .modal-footer {
    max-width: 212px;
  }
  body .modal.fade.bs-delete-repeating-events {
    max-width: 250px;
    margin-left: 40%;
  }
  body .modal.fade.bs-edit-repeating-events {
    max-width: 250px;
    margin-left: 40%;
  }
</style>
<!-- repeating events modal window -->
<div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header modal-sm">
       <!--       <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>-->
       <h4 class="modal-title">Repeating Event</h4>
     </div>
     <div class="modal-body">
      <!--      <p>One fine body&hellip;</p>-->
      <div class="btn-group-vertical">
        <button type="button" onclick="varRepeatingEvent=clickedNone()" class="btn btn-default" data-dismiss="modal" id="None">None</button>
        <button type="button" onclick="varRepeatingEvent=clickedEveryDay()" class="btn btn-default" data-dismiss="modal" id="EveryDay">Every Day</button>
        <button type="button" onclick="varRepeatingEvent=clickedEveryWeek()" class="btn btn-default" data-dismiss="modal" id="EveryWeek">Every Week</button>
        <button type="button" onclick="varRepeatingEvent=clickedEvery2Weeks()" class="btn btn-default" data-dismiss="modal" id="Every2Weeks">Every 2 Weeks</button>
        <button type="button" onclick="varRepeatingEvent=clickedEvery4Weeks()" class="btn btn-default" data-dismiss="modal" id="Every4Weeks">Every 4 Weeks</button>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
      <!--<button type="button" class="btn btn-primary">Done</button>-->
    </div>
  </div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->
</div>


</script>
<style>
  body .modal.fade.schedule-modal {
    max-width: 450px;
    margin-left: 30%;
  }
  body .modal-footer {
    max-width: 450px;
  }
</style>

<div class="modal fade schedule-modal" tabindex="-1" role="dialog" aria-labelledby="myScheduleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header modal-sm">
       <!--       <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>-->
       <h4 class="modal-title">Schedule An Event</h4>
     </div>
     <div class="modal-body">

      <div id="scroll-able-2">
        <div class="list-group col-xs-6 col-sm-9">
          <form class="list-group-item list-group-item-info" method="post" name="form">
            Select friends:<input id="schedule-search" size="17" name="search" type="text" />
            <input type="submit" value="Search" class="schedule-submit"/>
            <span class="error" style="display:none"> Please Enter Valid Data</span>
            <span class="success" style="display:none"></span></a>
          </form>
          <div class="schedule-output"></div>
        </div><!--/span-->
      </div>

      <div id="scroll-able">
        <div class="list-group col-xs-6 col-sm-9">
          <a class="list-group-item list-group-item-info">Invite List</a>
          <div class="Invite-list"></div>
        </div>
      </div>

    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-default" data-dismiss="modal" onclick="invite_cancel()">Cancel</button>
      <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="send_invite()">Invite!</button>
      <!--<button type="button" class="btn btn-primary">Done</button>-->
    </div>
  </div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->
</div>

<!-- the function to find the friends the user searches for -->
<div>
  <script type="text/javascript">

    $(function() {
      $(".schedule-submit").click(function() {

        var event_id = $('.party-button').attr("event");
        var name = $("#schedule-search").val();

        if (name == '')
        {
          $(".schedule-output").html('');
          //$('.success').fadeOut(200).hide();
          //$('.error').fadeOut(200).show();
        }
        else
        {

          $.ajax({
            type: "GET",
            url: "/calendar/invite_search/",
            data: {
              'search': name,
              'event': event_id,
            },
            success: function (data) {
              var mydata = JSON.parse(data);
              var dlength = mydata.length;
              userhtml = "";
              
              var event_obj = $('#calendar').fullCalendar('clientEvents', event_id)[0];
              if (event_obj.invitelist != undefined) {
                users = [];
                for (var i = 0; i < dlength; i++) {
                  if ($.inArray(mydata[i].fields.username, event_obj.invitelist) == -1) {
                    users.push(mydata[i]);
                  }
                }
              }
              else {
                users = mydata;
              }

              if (users.length != 0) {
                for (var i = 0; i < users.length; i++) {
                  userhtml = userhtml + '<div id="sch_' + users[i].fields.username + '"><a class="list-group-item"><img class="img-rounded" src="http://updog-assets.s3.amazonaws.com/media/profile_pictures/' + users[i].fields.username + '-social.jpg" alt = "profpic" width = "50" height = "50">  ' + users[i].fields.first_name + ' ' + users[i].fields.last_name + '<div style="float:right"><button type="button" onclick="invite(\'' + users[i].fields.username + '\', \'' + users[i].fields.first_name + '\', \'' + users[i].fields.last_name+ '\', \'' + event_id + '\' )">Invite</button></div></a></div>';
                }
              }
              else {
                userhtml = "No results.";

              }
              $(".schedule-output").html(userhtml);

            }
          });
}
return false;
});
});

function invite(user, user_firstname, user_lastname, event_id) {
    // delete sonia from above in search
    $("#sch_" + user).remove();
    // add sonia below
    addedhtml = "";
    addedhtml = addedhtml + '<div id="added_' + user + '"><a class="list-group-item"><img class="img-rounded" src="http://updog-assets.s3.amazonaws.com/media/profile_pictures/' + user + '-social.jpg" alt = "profpic" width = "50" height = "50">  ' + user_firstname + ' ' + user_lastname + '<div style="float:right"><button type="button" onclick="uninvite(\'' + user + '\', \'' + user_firstname + '\', \'' + user_lastname+ '\', \'' + event_id + '\' )">Uninvite</button></div></a></div>';
    var event_obj = $('#calendar').fullCalendar('clientEvents', event_id)[0];

    $(".Invite-list").append(addedhtml);

    // retrieve the event (on the front end) that we're editing
    var event_obj = $('#calendar').fullCalendar('clientEvents', event_id)[0];
    event_obj.invitelist.push(user);

  }

  function uninvite(user, user_firstname, user_lastname, event_id) {

    $("#added_" + user).remove();
    var event_obj = $('#calendar').fullCalendar('clientEvents', event_id)[0];
    var index = event_obj.invitelist.indexOf(user);
    if (index > -1) {
      event_obj.invitelist.splice(index, 1);
    }
  }
  
  function invite_cancel() {
    var event_id = $('.party-button').attr("event");
    var event_obj = $('#calendar').fullCalendar('clientEvents', event_id)[0];
    event_obj.invitelist = [];
  }

  function send_invite() {
    var event_id = $('.party-button').attr("event");
    var event_obj = $('#calendar').fullCalendar('clientEvents', event_id)[0];
    if (event_obj.invitelist) {
     if (event_obj.invitelist.length == 0) {
      alert("Please select some friends to invite.");
    }
    else {

      $.ajax({
        type: "POST",
        url: "/calendar/send_event_notifications/",
        data: {
          "event": event_id,
          "to_users": JSON.stringify(event_obj.invitelist),
          "data_type": "username",
        },

        success: function(data) {

          console.log("data");

        }
      });

      peeps_requested = is_invited(event_id, event_obj.invitelist);
      peeps_attending = is_attending(event_id, event_obj.invitelist);

      for (var k = 0; k < event_obj.invitelist.length; k++) {
        if (peeps_attending[k]) {
          $("#undesirablebutton_" + event_obj.invitelist[k]).html('Already Attending');
        }
        else {
          if (peeps_requested[k]) {
            $("#undesirablebutton_" + event_obj.invitelist[k]).html('Already Invited');
          }
        }
      }




    }
  }

  else {
    alert("You have invited no friends!");
  }
    //$dialog.dialog('close');
    //console.log("send teh einvite");

  }

</script>
</div>

<!-- do you want to delete this event only or all repeating events? modal dropdown -->
<div class="modal fade bs-delete-repeating-events" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <!--      <p>One fine body&hellip;</p>-->
        <div class="btn-group-vertical">
          <p>This is a repeating event.</p>
          <button type="button" class="btn btn-default" data-dismiss="modal" id="DeleteThisEventOnly">Delete This Event Only</button>
          <button type="button" class="btn btn-default" data-dismiss="modal" id="DeleteRepeatingEvents">Delete All Future Events</button>
          <button type="button" class="btn btn-default" data-dismiss="modal" id="CancelDeleteRepeatingEvents">Cancel</button>
        </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<!-- do you want to edit this event only or all repeating events? modal dropdown -->
<div class="modal fade bs-edit-repeating-events" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <!--      <p>One fine body&hellip;</p>-->
        <div class="btn-group-vertical">
          <p>This is a repeating event.</p>
          <button type="button" class="btn btn-default" data-dismiss="modal" id="EditThisEventOnly">Edit This Event Only</button>
          <button type="button" class="btn btn-default" data-dismiss="modal" id="EditRepeatingEvents">Edit All Future Events</button>
          <button type="button" class="btn btn-default" data-dismiss="modal" id="CancelEditRepeatingEvents">Cancel</button>
        </div>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div>

<style>
  div#scroll-able-2 {
    height: 200px;
    overflow: scroll;
  }
</style>

{% endblock %}
