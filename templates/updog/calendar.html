{% extends 'updog/base.html' %}

{% load static %}

{% block above_calendar_block %}

<div class="hero-unit">
  <br />
  <br />

  <center>
    <h1>What's Up, {{ user.first_name }}?</h1>
  </center>
  <br />
</div>

<script>
  $(document).ready(function() {
    $("#testForm").submit(function(event) {
        event.preventDefault();
        $.ajax({
           type: "POST",
           url: "/calendar/test_ajax/",
           success: function(data) {
              console.log( "ajax worked" );
              alert(data);
           },
        });
     });
  });
</script>

{% endblock %}

{% block calendar_block %}

<style>
div#scroll-able {
  height: 310px;
  overflow: scroll;
}
</style>

<!-- the function to find the friends the user searches for -->
<div>
  <script type="text/javascript">
    $(function() {
      $(".submit").click(function() {
        var name = $("#search").val();

          if (name == '')
        {
          $('.success').fadeOut(200).hide();
          $('.error').fadeOut(200).show();
        }
        else
        {
          $.ajax({
            type: "GET",
            url: "/calendar/find_friends/",
            data: {"search": name,
            },
            success: function(data) {
              mydata = JSON.parse(data);
              if (data.length > 0) {
                var dlength = mydata.length;
                var users = [];
                var isFriend = 0;
                userhtml = "";

                for (var i = 0; i < dlength; i++) {
                  isFriend = 0;
                  {% if friends_list %}
                    {% for friend in friends_list %}
                      if ('{{ friend }}' === mydata[i].fields.username)
                        isFriend = 1;
                    {% endfor %}
                  {% endif %}

                  if (mydata[i].fields.username != '{{ user.username }}' && isFriend == 0) {
                    users.push(mydata[i].fields.username);
                  }
                };
              }
              if (users.length != 0) {
                for (var i = 0; i < users.length; i++) {
                userhtml = userhtml + '<div><a class="list-group-item"><img src="/media/profile_pictures/' + users[i] + '-social.jpg" alt = "profpic" width = "50" height = "50"> ' + mydata[i].fields.first_name + ' ' +  mydata[i].fields.last_name + '<div style="float:right"><button type="button" onclick="send_friend_request(\'' + users[i] + '\', \'' + i +'\')"> add </button></div><div id="div' + i + '"></div></a></div>';
                }
              }
                $('.error').fadeOut(200).hide();
                $(".output").html(userhtml);
            }
          });
        }
      return false;
    });
  });
  </script>
</div>

<!-- THIS IS THE CALENDAR!!! -->
<div class="span12">
  <div class="row-fluid">
    <div class="col-xs-6 col-sm-9">
      <div id='calendar'></div>
      <div class="ui-helper-hidden" id="calendar-details" title="Event Details">
        <p>Event details</p>
      </div>
    </div>

    <!-- this is the friends tab -->
    {% if user.is_authenticated %}
    <div class="col-xs-6 col-sm-3 sidebar-offcanvas" id="sidebar" role="navigation">
      <div id="scroll-able"> 
        <div class="list-group">
          <div class="frandz"></div>
            <!--{% if friends_list %}
            <a class="list-group-item active">
              Friends:
            </a>  
            {% for friend in friends_list %}
              <a class="list-group-item" onclick="getevents( '{{ friend }}' )" id="friend_{{ friend }}"> 
               <div><img src="/media/profile_pictures/{{ friend }}-social.jpg" alt = "profpic" width = "50" height = "50">
               <span class="frand">{{ friend.first_name }} {{ friend.last_name }}</span>
               </div>
              </a>-->
              <script>


              /*hover_functions = {
                sensitivity: 3,
                interval: 50,
                timeout: 50,
                over: function on_hover() {

              var obj = '{{ friend }}';
              $.ajax({
              type: "POST",
              url: "/calendar/get_friends_downtimes/",
              data: {'friend': obj, 'display_date': $('#calendar').fullCalendar('getDate').toUTCString(),},
              success: function(data) {

                    var our_data = JSON.parse(data);
                    var get_some_events = make_events(our_data, 'orange', obj, true, false);

                    if (get_some_events) {
                      existing_events = $("#calendar").fullCalendar('clientEvents');
    
                      for (var i = 0; i < get_some_events.length; i++) {
                        var is_unique = true;
                        for (var j = 0; j < existing_events.length; j++) {
                          if (get_some_events[i].id == existing_events[j].id) {
                            is_unique = false;
                          }

                        }
                        if (is_unique) {
                          $("#calendar").fullCalendar('renderEvent', get_some_events[i], stick=true);
                          }
                        }

                      }
                    },
                  });

                },
                out: function off_hover() {
                  var obj = '{{ friend }}';
                  existing_events = $("#calendar").fullCalendar('clientEvents');
                  for (var i = 0; i < existing_events.length; i++) {
                    if (existing_events[i].owner === "hover") {
                      $('#calendar').fullCalendar('removeEvents', existing_events[i].id);
                    }
                  }
                  $('#calendar').fullCalendar('rerenderEvents');
                }

              }

              $( "#friend_{{ friend }}").hoverIntent(hover_functions);*/

              </script>
            <!--{% endfor %}
          {% else %}
            <strong>No friends.</strong>
          {% endif %}-->
        </div>
      </div>
      <!-- this is the searchbar -->
      <div id="scroll-able">
          <div class="list-group">
              <form class="list-group-item list-group-item-info" method="post" name="form">
                Find friends:<input id="search" size="17" name="search" type="text" />
                <input type="submit" value="Search" class="submit"/>
                <span class="error" style="display:none"> Please Enter Valid Data</span>
                <span class="success" style="display:none"></span></a>
              </form>
            <div class="output"></div>
          </div><!--/span-->
      </div>
    {% endif %}
    <br>
  </div>
</div>

<script>

function send_friend_request(new_friend, i) {
  $.ajax({
    type: "POST",
    url: "/calendar/send_friend_request/",
    data: {'new_friend': new_friend, 'i': i},
    success: function(data) {
      var s = data.indexOf(',');
      var data1 = data.substring(0,s);
      var data2 = data.substring(s+1, data.length);
      if (data1 === "Request Pending") {
        $("#div"+data2).text("Request Pending");
      }
      else {
        $("#div"+data2).text("friend request sent");
      }
    }

  });
}

</script>

<script>
function get_friends(user) {
  $.ajax({
    type: "GET",
    url: "/calendar/get_friends/",
    data: {'user': user},
    success: function(data) {
      real_data = JSON.parse(data);
      // everything before this pulls friends
      fl = real_data.length
      userhtml = ''
        if (fl != 0) {
        userhtml = userhtml + '<a class="list-group-item active">Friends:</a>';
        
          for (var i = 0; i < fl; i++) {
            userhtml = userhtml + '<a class="list-group-item" onclick="getevents(\'' + real_data[i].fields.username + '\')" id="friend_' + real_data[i].fields.username + '"><div><img src="/media/profile_pictures/' + real_data[i].fields.username + '-social.jpg" alt = "profpic" width = "50" height = "50"><span class="frand">' + real_data[i].fields.first_name + ' ' + real_data[i].fields.last_name + '</span></div></a>';
          };
        } else {
          userhtml = '<strong>No friends.</strong>';
      };
      $(".frandz").html(userhtml);
      for (var i = 0; i < fl; i++) {
        hover_stuff(real_data[i]);
      };
    } 
  });
}
</script>

<script>

function hover_stuff(friend) {
hover_functions = {
  sensitivity: 3,
  interval: 50,
  timeout: 50,
  over: function on_hover() {
    var obj = friend.fields.username;
  $.ajax({
    type: "POST",
    url: "/calendar/get_friends_downtimes/",
    data: {'friend': obj, 'display_date': $('#calendar').fullCalendar('getDate').toUTCString(),},
    success: function(data) {

      var our_data = JSON.parse(data);
      var get_some_events = make_events(our_data, 'orange', obj, true, false);

      if (get_some_events) {
        existing_events = $("#calendar").fullCalendar('clientEvents');
    
        for (var i = 0; i < get_some_events.length; i++) {
          var is_unique = true;
          for (var j = 0; j < existing_events.length; j++) {
            if (get_some_events[i].id == existing_events[j].id) {
              is_unique = false;
            }
          }
          if (is_unique) {
            $("#calendar").fullCalendar('renderEvent', get_some_events[i], stick=true);
          }
        }

      }
    },
  });

  },
  out: function off_hover() {
    var obj = friend;
    existing_events = $("#calendar").fullCalendar('clientEvents');
    for (var i = 0; i < existing_events.length; i++) {
      if (existing_events[i].owner === "hover") {
        $('#calendar').fullCalendar('removeEvents', existing_events[i].id);
      }
    }
    $('#calendar').fullCalendar('rerenderEvents');
  }
}
$( "#friend_" + friend.fields.username).hoverIntent(hover_functions);
}
</script>

<script>
  var x = get_friends('{{ user }}');
</script>

<script>
    function getevents(obj) {
      $.ajax({
      type: "POST",
      url: "/calendar/get_friends_downtimes/",
      data: {'friend': obj, 'display_date': $('#calendar').fullCalendar('getDate').toUTCString(),},
      success: function(data) {

        var our_data = JSON.parse(data);
        var get_some_events = make_events(our_data, 'orange', obj, false, false);
        if (get_some_events) {
  
            existing_events = $("#calendar").fullCalendar('clientEvents');
  
            for (var i = 0; i < get_some_events.length; i++) {
              var is_unique = true;
              for (var j = 0; j < existing_events.length; j++) {
                if (get_some_events[i].id == existing_events[j].id) {
                  if (existing_events[j].owner != "hover") {
                    is_unique = false;
                  }
                  // existing event owner is hover
                  else {
                    $('#calendar').fullCalendar('removeEvents', existing_events[j].id); // remove the one with 'hover' owner
                  }

                }
              }
              if (is_unique) {
                $("#calendar").fullCalendar('renderEvent', get_some_events[i], stick=true);
                
              }
            }
            var test = document.getElementById('friend_'+obj);  
            test.setAttribute("onclick", "erase_events("+JSON.stringify(obj)+")");

            }
       },
      });

    }
    function erase_events(obj) {
  
      existing_events = $("#calendar").fullCalendar('clientEvents');
      for (var i = 0; i < existing_events.length; i++) {
        if (existing_events[i].owner == obj) {
          $('#calendar').fullCalendar('removeEvents', existing_events[i].id);
        }
      }
      $('#calendar').fullCalendar('rerenderEvents');

      var test = document.getElementById('friend_'+obj);
      test.setAttribute("onclick", "getevents("+JSON.stringify(obj)+")");


    }

</script>

<div>
  <script>
    // This function converts a Date object, date, into a time of the form: 2:00 PM or 11:00 AM
    function getTime(date) {
      var local_time = date.toLocaleTimeString()
      var lt_length = local_time.length;

      return local_time.substring(0, lt_length - 6) + local_time.substring(lt_length - 3, lt_length)
    } 
    $(document).ready(function() {

      /*{% autoescape off %}
        var data = {{ events_list }};
        var downtime_data = {{ downtimes }};
      {% endautoescape %}

    var multiple = make_events(data, 'blue', '{{ username }}', false, true);
    var downtimes = make_events(downtime_data, 'green', '{{ username }}', false, false);
    var downtimes_and_events;
    if (multiple) {

      if (downtimes) {

        downtimes_and_events = multiple.concat(downtimes);
      }

      else downtimes_and_events = multiple;
    }

    else if (downtimes) downtimes_and_events = downtimes;*/


    var date = new Date();
    var d = date.getDate();
    var m = date.getMonth();
    var y = date.getFullYear();

    // variables for dayClick double clicking capabilities
    var clickTimer;
    var doubleClick;

    var $dialog = $('#calendar-details').dialog({
      autoOpen: false,
      model: true,
      height: 300,
      width: 350
    });

    // this creates a datepicker object below the calendar
    $('#datepicker').datepicker({
        inline: true,
        onSelect: function(dateText, inst) {
            var d = new Date(dateText);
            $('#fullcalendar').fullCalendar('gotoDate', d);
        }
    }); 

      $('#calendar').fullCalendar(
      {

      viewDisplay: function(view) {
        var d = $('#calendar').fullCalendar('getDate');
        $.ajax({

        type: "POST",
        url: "/calendar/display/",
        data: {'display_date': d.toUTCString()},
        success: function(data) {
          var my_data = JSON.parse(data);
          var downtimes_vd = [];
          var events_vd = [];

          existing_events = $("#calendar").fullCalendar('clientEvents');
          for (var i = 0; i < my_data.length; i++) {
            unique = true;
            for (var j = 0; j < existing_events.length; j++) {
              if (existing_events[j].id == my_data[i].pk && ((my_data[i].model == "udCalendar.downtime" && existing_events[j].is_event == false) || (my_data[i].model == "udCalendar.event" && existing_events[j].is_event == true))) {
                unique = false;
              }

            }

            if (unique) {
              if (my_data[i].model == "udCalendar.downtime") {

                downtimes_vd.push(my_data[i]);

              }
              else {
                events_vd.push(my_data[i]);
              }
            }
          }
          var multiple_evs = make_events(events_vd, 'blue', '{{ username }}', false, true);
          var multiple_dts = make_events(downtimes_vd, 'green', '{{ username }}', false, false);
          var dts_and_evs;
          if (multiple_evs) {

            if (multiple_dts) {

              dts_and_evs = multiple_evs.concat(multiple_dts);
            }

            else dts_and_evs = multiple_evs;
          }

          else if (multiple_dts) dts_and_evs = multiple_dts;

          if (dts_and_evs) {
            for (var i = 0; i < dts_and_evs.length; i++) {
              $('#calendar').fullCalendar('renderEvent', dts_and_evs[i], stick = true);
            }
          }


        }

        });
        },
      header: {
      left: 'prev,next today',
      center: 'title',
      right: 'month,agendaWeek',
      },

      selectable: true,
      selecthelper: true,
      editable: false, // TESTING IT OUT AS FALSE, DONT KILL ME FRANKLYN
      // set the default view to be the agendaWeek view
      defaultView: 'agendaWeek',
      //events: downtimes_and_events,
      allDaySlot: false,
      firstDay: date.getDay(),
      firstHour: 8,

      // Use below if you want something to happen after
      // clicking on an existing event in the calendar
      eventClick: function(event, jsEvent, view) {
        console.log(event.color);
        if (event.is_event) {
        $dialog.dialog({title:event.title});

        var edit = document.createElement("input");
        edit.setAttribute('type', "submit");
        edit.setAttribute('value', "Edit Event");
        edit.onclick = function() {

          $dialog.dialog('close');
          $dialog.dialog(
            {
              title:'Edit Event',
              width: 500,
              height: 250
            }
            );

          var activity_text = document.createElement("span");
          activity_text.innerHTML = 'Activity (optional): &nbsp';
          var activity = document.createElement("input");
          activity.setAttribute('type', "text");
          activity.setAttribute('name', "activity");
          activity.setAttribute('id', 'activity_field');

          var location_text = document.createElement("span");
          location_text.innerHTML = '<br/>Location (optional): ';
          var location = document.createElement("input");
          location.setAttribute('type', "text");
          location.setAttribute('name', "location");
          location.setAttribute('id', 'location_field');
          // find where the last index of the substring " in " exists.  Assume what
          // comes before is the activity and what comes after is the location.
          var i = 0;
          // the following handles what shows up in the fields when you click
          // "edit event" based on the event title
          if (event.title != "Busy") {
            if (event.title.substring(0, 8) != "Busy in ") {
              if (event.title.indexOf(" in ") > -1) {
                while (event.title.substring(i, event.title.length).indexOf(" in ") != -1) {
                    i = i + event.title.substring(i, event.title.length).indexOf(" in ");
                    // increment i by 3 because we look past the found " in "
                    i = i + 3;
                }
                if (i != -1) {
                  activity.setAttribute('value', event.title.substring(0, i - 3));
                }
                else activity.setAttribute('value', event.title);
                if (i != -1) {
                  location.setAttribute('value', event.title.substring(i + 1, event.title.length));
                }
              }
              else activity.setAttribute('value', event.title);
            }
            else {
              location.setAttribute('value', event.title.substring(8, event.title.length));
            }
          }

          // span makes it so there's no newline at the end, while "br" would
          // include the newline
          start_text = document.createElement("span");
          // &nbsp is a non-breaking whitespace character
          start_text.innerHTML = '<br/>Start Time: &nbsp&nbsp&nbsp&nbsp&nbsp';




          // dialog box's startTime input field
          var startTime = document.createElement("input");
          startTime.id = "txtStartTime";
          startTime.type = "text";
          startTime.className = 'input-small';
          startTime.style.width = "85px";
          // dialog box's endTime input field
          var endTime = document.createElement("input");
          endTime.id = "txtEndTime";
          endTime.type = "text";
          endTime.className = 'input-small';
          endTime.style.width = "85px";
          // is the time in the morning (AM) or afternoon (PM)
          var start_am_pm = "PM";
          var startHour = event.start.getHours();
          if (startHour == 0) {
            startHour = 12;
            start_am_pm = "AM";
          }
          else if (startHour < 12) {
            start_am_pm = "AM";
          }
          // if the time is PM, don't use military time (eg. 13:00 ==> 1:00)
          else if (startHour != 12) {
            startHour = startHour - 12;
          }
          var startMinute = event.start.getMinutes();
          // set the initial start time to be the time that was clicked to make the event
          startTime.setAttribute('value', startHour + ':' + startMinute + ' ' + start_am_pm);

          // increment the initial end time to be one hour (3.6e6 milliseconds) later than the initial start time
          var endDateObject = event.end;
          var end_am_pm = "PM";
          var endHour = endDateObject.getHours();
          if (endHour == 0) {
            endHour = 12;
            end_am_pm = "AM";
          }
          else if (endHour < 12) {
            end_am_pm = "AM";
          }
          else if (endHour != 12) {
            endHour = endHour - 12;
          }
          var endMinute = endDateObject.getMinutes();
          // set the initial start time to be the time that was clicked to make the event
          endTime.setAttribute('value', endHour + ':' + endMinute + ' ' + end_am_pm);

          // the box that holds the startTime timepicker
          var lblStartTime = document.createElement('label')
          lblStartTime.htmlFor = "txtStartTime";
          lblStartTime.appendChild(document.createTextNode('fromTime'));
          // the box that holds the endTime timepicker
          var lblEndTime = document.createElement('label')
          lblEndTime.htmlFor = "txtEndTime";
          lblEndTime.appendChild(document.createTextNode('toTime'));

          var newline = document.createElement("span");
          newline.innerHTML = ' <br/>';

          // span makes it so there's no newline at the end, while "br" would
          // include the newline
          date_text = document.createElement("span");
          // &nbsp is a non-breaking whitespace character
          date_text.innerHTML = '<br/>Event Dates: ';

          var startDate = document.createElement("input");
          startDate.id = "txtStartDate";
          startDate.type = "text";
          startDate.className = "datepicker";
          startDate.style.width = "85px";
          startDate.readonly = "readonly";
                
          // January is 0 so we add 1
          var startMonth = event.start.getMonth() + 1;
          if (startMonth < 10) {
            startMonth = '0' + startMonth;
          }
          var startDay = event.start.getDate();
          console.log(event.start);
          if (startDay < 10) {
            startDay = '0' + startDay;
          }
          // when editing an event, the start date is displayed
          startDate.setAttribute('value', startMonth + '/' + startDay + '/' + event.start.getFullYear());
          var lblStartDate = document.createElement('label')
          lblStartDate.htmlFor = "txtStartDate";
          lblStartDate.appendChild(document.createTextNode('fromDate'));

          to_text = document.createElement("span");
          // &nbsp is a non-breaking whitespace character
          to_text.innerHTML = '&nbsp to &nbsp';

          var endDate = document.createElement("input");
          endDate.id = "txtEndDate";
          endDate.type = "text";
          endDate.className = "datepicker";
          endDate.style.width = "85px";
          endDate.readonly = "readonly";

          // January is 0 so we add 1
          var endMonth = event.end.getMonth() + 1;
          if (endMonth < 10) {
            endMonth = '0' + endMonth;
          }
          var endDay = event.end.getDate();
          if (endDay < 10) {
            endDay = '0' + endDay;
          }

          // when editing an event, the end date is displayed
          endDate.setAttribute('value', endMonth + '/' + endDay + '/' + event.end.getFullYear());

          var lblEndDate = document.createElement('label')
          lblEndDate.htmlFor = "txtEndDate";
          lblEndDate.appendChild(document.createTextNode('toDate'));

          // input box
          var start_time = document.createElement("input");
          // you are typing text into the box
          start_time.setAttribute('type', "text");
          // can reference this by using "start_time"
          start_time.setAttribute('name', "start_time");
          start_time.innerHTML = '<input type="text" class="form-control  datepicker" id="datepicker" data-date-format="dd/mm/yyyy" />';

          end_text = document.createElement("span");
          end_text.innerHTML = '<br/>End Time: &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp';
          var end_time = document.createElement("input");
          end_time.setAttribute('type', "test");
          end_time.setAttribute('name', "end_time");

          $dialog.empty().append(activity_text);
          $dialog.append(activity);
          $dialog.append(location_text);
          $dialog.append(location);

          $dialog.append(date_text);
          $dialog.append(startDate);
          $dialog.append(startTime);

          $dialog.append(to_text);

          $dialog.append(endDate);
          $dialog.append(endTime);
          $dialog.append(newline);

         //////// $dialog.append(startTime);

          // the options that our datepicker will use
          var datePickerOptions = {
              autoclose: true,
              todayBtn: true,
              todayHighlight: true

              // make this value the selected date so they can't have something start on one day and end on a later day
              //startDate:
          };

          $(startTime).timepicker();
          $(endTime).timepicker();

          $(startDate).datepicker(datePickerOptions);
          $(endDate).datepicker(datePickerOptions);

/*
          var timePickerOptions = {
            useSelect: true
          };

          console.log(startTime.className);
          $(startTime).pickatime();*/

          var cancel = document.createElement("input");
          cancel.setAttribute('type', "submit");
          cancel.setAttribute('value', "Cancel");

          cancel.onclick = function() {
            $dialog.dialog('close');
          };

          var submit = document.createElement("input");
          submit.setAttribute('type',"submit");
          submit.setAttribute('value', "Submit Change");

          submit.onclick = function() {
            console.log("paoisjdfpoiasjdfpoiajsdpfoiajsdpf");

            $.ajax({
              type: "POST",
              url: "/calendar/edit_event/",
              data: {'activity': $('#activity_field').val(),
              'location': $('#location_field').val(),
              'pk': event.id,
              'start_date': $('#txtStartDate').val(),
              'end_date': $('#txtEndDate').val(),
              'start_time': $('#txtStartTime').val(),
              'end_time': $('#txtEndTime').val()
              },
               success: function(data) {
                  // data[0] now holds the event to add
                  var data = JSON.parse(data);
                  // this flag will be false if the dates are
                  // invalid, in which case the event won't be
                  // added
                  var valid_dates = true;

                  console.log(data[0].fields.start_time);

                  // get the day, month, and year for the start and end dates
                  var start_year = data[0].fields.start_time.substring(0,4);
                  var start_month = data[0].fields.start_time.substring(5,7);
                  var start_day = data[0].fields.start_time.substring(8,10);
                  var start_hour = data[0].fields.start_time.substring(11,13);
                  var start_minute = data[0].fields.start_time.substring(14,16);
                  var start_second = data[0].fields.start_time.substring(17,19);

                  var end_year = data[0].fields.end_time.substring(0,4);
                  var end_month = data[0].fields.end_time.substring(5,7);
                  var end_day = data[0].fields.end_time.substring(8, 10);
                  var end_hour = data[0].fields.end_time.substring(11,13);
                  var end_minute = data[0].fields.end_time.substring(14,16);
                  var end_second = data[0].fields.end_time.substring(17,19);

                  var firstDate = new Date(start_year, start_month, start_day, start_hour, start_minute, start_second, 0);
                  var secondDate = new Date(end_year, end_month, end_day, end_hour, end_minute, end_second, 0);
                  
                  // don't edit the event if the dates aren't chronological
                  if (firstDate >= secondDate) {
                    alert("Your event's start date must occur before its end date.");
                  }
                  else {
                    $('#calendar').fullCalendar('removeEvents', event.id);
                    $('#calendar').fullCalendar('rerenderEvents');

                    var added_event = make_events(data, 'blue', '{{username}}', false, true)[0];

                    console.log( "pk1 = " + data[0].pk );
                    console.log( "added_event.id = " + added_event.id)

                    $('#calendar').fullCalendar('renderEvent', added_event, stick = true);
                    $dialog.dialog('close');
                  }
               },
            });
          };

          $dialog.append(cancel);
          $dialog.append(submit);
          $dialog.dialog('open');
        };

        var del = document.createElement("input");
        del.setAttribute('type',"submit");
        del.setAttribute('value', "Delete Event");
        del.onclick = function() {
          // THE COMMENTED LINE BELOW ASKS IF YOU ARE SURE YOU WANT TO DELETE
          // THE EVENT
    //////      if( confirm( "Are you sure you want to delete event " + event.title + " ?")) {
            console.log("Delete Function");
            $.ajax({
              type: "POST",
              url: "/calendar/remove_event/",
              data: {"pk": event.id},
               success: function(data) {
                  console.log( "ajax to remove!!!" );

                  // IF EVENT!!!! IS AN EVENT, IT WILL POPULATE THE CALENDAR IMMEDIATELY
                  /////$('#calendar').fullCalendar('renderEvent', EVENT!!!!)
               },
            })
            $('#calendar').fullCalendar('removeEvents', function (our_event) {
              if (our_event.id == event.id) {
                if (our_event.is_event == event.is_event) {
                  return true;
                }
              }
              return false;
            });
            $('#calendar').fullCalendar('rerenderEvents');
            
            $dialog.dialog('close');
    ///////      }
        };

        $($dialog).empty().append(
          $('<p />').text(event.start.toDateString())
        );
        $($dialog).append(
          $('<p />').text(event.allDay ? 'All day event' : getTime(event.start) + '-' + getTime(event.end))
        );
        if (event.location)
        $($dialog).append(
          $('<p />').text(event.allDay ? 'All day event' : getTime(event.start) + '-' + getTime(event.end))
        );

        var cancel = document.createElement("input");
        cancel.setAttribute('type', "submit");
        cancel.setAttribute('value', "Cancel");

        cancel.onclick = function() {
          $dialog.dialog('close');
        };

        $dialog.append(cancel);
        $($dialog).append(edit);
        $($dialog).append(del);
        $dialog.dialog('open');
      }
      // edit downtimes
      else if (event.owner == '{{ username }}') {
        
        $dialog.dialog({title:event.title});
        var suggest = document.createElement("input");
        suggest.setAttribute('type', "submit");
        suggest.setAttribute('value', "Suggest");
        suggest.onclick = function() {
          $.ajax({
          type: "GET",
          url: "/calendar/suggest/",
          data: {'pk': event.id},
          success: function(data) {
            // Make the unconfirmed event show up in your calendar
            if (data === "None") {
              alert("You have no upcoming downtimes.")
            }
            else {
              if (data == "NoFriends") {
                alert("You have no friends.")
              }
              else {
                if (data == "NoMatch") {
                  alert("No free times align")
                }
                else {
                  var r = confirm("Send Request?");
                  // if user clicked Okay:
                  if (r == true) {
                    // send the other user a request:
                    //************** SEND EVENT NOTIFICATION *******************//







                    //************** SEND EVENT NOTIFICATION *******************//

                    // display the unconfirmed event on the initiator's calendar
                    var mydata = JSON.parse(data);
                    var unconf = make_events(mydata, 'orange', '{{ username }}', false, true);
                    $("#calendar").fullCalendar('renderEvent', unconf[0], stick=true);
                  }
                  // if user clicked Cancel:
                  else {
                    // remove the unconfirmed event from the back end
                    $.ajax({
                        type: "POST",
                        url: "/calendar/remove_event/",
                        data: {"pk": JSON.parse(data)[0].pk},
                      });

                    }

                  
                }
              }
            }
          }
        });
        $dialog.dialog('close');
        };

        var edit = document.createElement("input");
        edit.setAttribute('type', "submit");
        edit.setAttribute('value', "Edit Downtime");
        edit.onclick = function() {

          $dialog.dialog('close');
          $dialog.dialog({title:'Edit Downtime'});

          var activity_text = document.createElement("span");
          activity_text.innerHTML = 'Preferred Activity: &nbsp';
          var activity = document.createElement("input");
          activity.setAttribute('type', "text");
          activity.setAttribute('name', "activity");
          activity.setAttribute('id', 'activity_field'); 

          if (event.title != "{{username}} is free") {

            var nameLength = "{{username}}".length;
            activity.setAttribute("value", event.title.substring(nameLength + 10, event.title.length));
          }

          // span makes it so there's no newline at the end, while "br" would
          // include the newline
          start_text = document.createElement("span");
          // &nbsp is a non-breaking whitespace character
          start_text.innerHTML = '<br/>Start Time: &nbsp&nbsp&nbsp&nbsp&nbsp';
          // input box
          var start_time = document.createElement("input");
          // you are typing text into the box
          start_time.setAttribute('type', "text");
          // can reference this by using "start_time"
          start_time.setAttribute('name', "start_time");
          start_time.setAttribute('id', 'st_field');
          end_text = document.createElement("span");
          end_text.innerHTML = '<br/>End Time: &nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp';
          var end_time = document.createElement("input");
          end_time.setAttribute('type', "test");
          end_time.setAttribute('name', "end_time");
          end_time.setAttribute('id', 'et_field');

          var newline = document.createElement("span");
          newline.innerHTML = '<br/>';

          $dialog.empty().append(activity_text);
          $dialog.append(activity);
          $dialog.append(start_text);
          $dialog.append(start_time);
          $dialog.append(end_text);
          $dialog.append(end_time);
          $dialog.append(newline);

          var cancel = document.createElement("input");
          cancel.setAttribute('type', "submit");
          cancel.setAttribute('value', "Cancel");

          cancel.onclick = function() {
            $dialog.dialog('close');
          };

          var submit = document.createElement("input");
          submit.setAttribute('type',"submit");
          submit.setAttribute('value', "Submit Change");

          submit.onclick = function() {

            $.ajax({
              type: "POST",
              url: "/calendar/edit_downtime/",
              data: {'activity': $('#activity_field').val(),
              'pk': event.id,
              'starttime': $('#st_field').val(),
              'endtime': $('#et_field').val(),

              },
                  success: function(data) {

                    parsed = JSON.parse(data);
                    if ($('#activity_field').val().length == 0) {
                      event.title = event.title.split(" ")[0] + ' is free';
                    }
                    else {
                      event.title = event.title.split(" ")[0] + ' wants to ' + $('#activity_field').val();
                    }
                    
                    $("#calendar").fullCalendar('renderEvent', event, stick=true);
                    if (parsed.length > 1) {
                      event.start = parsed[0].fields.start_time;
                      event.end = parsed[0].fields.end_time;
                      $("#calendar").fullCalendar('renderEvent', event, stick=true);
                      for (var i = 0; i < parsed.length; i++) {
                        if (parsed[i].pk != event.id) {
                          $('#calendar').fullCalendar('removeEvents', parsed[i].pk);
                        }
                      }
                    }
                    else {
                      if (parsed.length == 1) {
                        $('#calendar').fullCalendar('removeEvents', parsed[0].pk);
                      }
                    }
                    if (parsed.length != 0) {
                      $('#calendar').fullCalendar('rerenderEvents'); 
                    }
                    $dialog.dialog('close');
                  },

                  
            });
          };

          $dialog.append(cancel);
          $dialog.append(submit);
          $dialog.dialog('open');
        };

        var del = document.createElement("input");
        del.setAttribute('type',"submit");
        del.setAttribute('value', "Delete Downtime");
        del.onclick = function() {
          // THE COMMENTED OUT LINE BELOW ASKS IF YOU ARE SURE YOU WANT
          // TO DELETE AN EVENT
        ///////  if( confirm( "Are you sure you want to delete this downtime?")) {
            //console.log("Delete Function");
            $.ajax({
              type: "POST",
              url: "/calendar/remove_downtime/",
              data: {"pk": event.id},
               success: function(data) {
                  //console.log( "ajax to remove!!!" );

                  // IF EVENT!!!! IS AN EVENT, IT WILL POPULATE THE CALENDAR IMMEDIATELY
                  /////$('#calendar').fullCalendar('renderEvent', EVENT!!!!)
               },
            });

            $('#calendar').fullCalendar('removeEvents', function (our_event) {
                  if (our_event.id == event.id) {
                    if (our_event.is_event == event.is_event) {
                      return true;
                    }
                  }
                  return false;
              });
            $('#calendar').fullCalendar('rerenderEvents');
            
            $dialog.dialog('close');
   //////       }
        };

        $($dialog).empty().append(
          $('<p />').text(event.start.toDateString())
        );
        $($dialog).append(
          $('<p />').text(event.allDay ? 'All day event' : getTime(event.start) + '-' + getTime(event.end))
        );
        if (event.location)
        $($dialog).append(
          $('<p />').text(event.allDay ? 'All day event' : getTime(event.start) + '-' + getTime(event.end))
        );

        var cancel = document.createElement("input");
        cancel.setAttribute('type', "submit");
        cancel.setAttribute('value', "Cancel");

        cancel.onclick = function() {
          $dialog.dialog('close');
        };

        $dialog.append(cancel);
        $($dialog).append(edit);
        $($dialog).append(del);
        $dialog.dialog('open');
        $dialog.append(suggest);
        }
      },
      eventDrop: function(event,dayDelta,minuteDelta,revertFunc) {

        if (event.is_event) {
          $.ajax({
            type: "POST",
            url: "/calendar/change_event/",
            data: {"pk": event.id, 
                  "day_delta": dayDelta,
                  "minute_delta": minuteDelta,
                  "resize": "false",
                },
          });
        }

        else {

          $.ajax({
            type: "POST",
            url: "/calendar/change_downtime/",
            data: {"pk": event.id, 
                  "day_delta": dayDelta,
                  "minute_delta": minuteDelta,
                  "resize": "false",
                },
            success: function(data) {

              parsed = JSON.parse(data);
              if (parsed.length > 1) {
                event.start = parsed[0].fields.start_time;
                event.end = parsed[0].fields.end_time;
                $("#calendar").fullCalendar('renderEvent', event, stick=true);
                for (var i = 0; i < parsed.length; i++) {
                  if (parsed[i].pk != event.id) {
                    $('#calendar').fullCalendar('removeEvents', parsed[i].pk);
                  }
                }
              }
              else {
                if (parsed.length == 1) {
                  $('#calendar').fullCalendar('removeEvents', parsed[0].pk);
                }
              }
              if (parsed.length != 0) {
                $('#calendar').fullCalendar('rerenderEvents'); 
              }               
            },
          });
        }
      },
      eventResize: function(event,dayDelta,minuteDelta,revertFunc) {

      if (event.is_event) {
        $.ajax({
          type: "POST",
          url: "/calendar/change_event/",
          data: {"pk": event.id, 
                "day_delta": dayDelta,
                "minute_delta": minuteDelta,
                "resize": "true",
              },
        });
      }

      else {

        $.ajax({
          type: "POST",
          url: "/calendar/change_downtime/",
          data: {"pk": event.id, 
                "day_delta": dayDelta,
                "minute_delta": minuteDelta,
                "resize": "true",
              },
          success: function(data) {
            parsed = JSON.parse(data);
            if (parsed.length > 1) {
              event.start = parsed[0].fields.start_time;
              event.end = parsed[0].fields.end_time;
              $("#calendar").fullCalendar('renderEvent', event, stick=true);
              for (var i = 0; i < parsed.length; i++) {
                if (parsed[i].pk != event.id) {
                  $('#calendar').fullCalendar('removeEvents', parsed[i].pk);
                }
              }
            }
            else {
              if (parsed.length == 1) {
                $('#calendar').fullCalendar('removeEvents', parsed[0].pk);
              }
            }
            if (parsed.length != 0) {
              $('#calendar').fullCalendar('rerenderEvents'); 
            }
            
          },
        });
      }


    },

      select: function(startDate, endDate, allDay, jsEvent, view) {

        if (startDate - endDate == -1800000) return;

        startDateOffset = startDate.getTimezoneOffset();
        startDate = new Date(startDate.getTime() - startDateOffset*60000);

        endDate = new Date(endDate.getTime() - startDateOffset*60000);

        $.ajax({
          type:"POST",
          url: "/calendar/add_downtime/",
          data: {"startDate": startDate.toUTCString(),
                "endDate": endDate.toUTCString(),
                "allDay": allDay,
              },
              success: function(data) {
                parsed = JSON.parse(data)
                if (parsed.length > 0) {
                  if (parsed.length > 1) {
                    if (parsed[1].pk != parsed[0].pk) {
                      var displayed_downtime = make_events(parsed, 'green', "{{ username }}", false, false);
                      $("#calendar").fullCalendar('renderEvent', displayed_downtime[0], stick=true);
                      for (var i = 1; i < displayed_downtime.length; i++) {
                        $('#calendar').fullCalendar('removeEvents', parsed[i].pk);
                      }
                      $('#calendar').fullCalendar('rerenderEvents');
                    }
                  }
                  else {
                    var displayed_downtime = make_events(parsed, 'green', "{{ username }}", false, false);
                    $("#calendar").fullCalendar('renderEvent', displayed_downtime[0], stick=true);
                  }
                }         
              },
        });
      },

      dayClick:function( date, allDay, jsEvent, view ) {
            var singleClick = date.toUTCString();

            // double click
            if(doubleClick==singleClick){
                console.log('Double-click!');
                doubleClick = null;

                $dialog.dialog(
                  {
                    title:'Add Event',
                    width: 500,
                    height: 200
                  }
                );

                // dialog box's activity text
                var activity_text = document.createElement("span");
                activity_text.innerHTML = 'Activity (opt): &nbsp';
                // dialog box's activity input field
                var activity = document.createElement("input");
                activity.setAttribute('type', "text");
                activity.setAttribute('name', "activity");
                activity.setAttribute('id', 'activity_field'); 
                // dialog box's location input field
                var location_text = document.createElement("span");
                location_text.innerHTML = '<br/>Location (opt): ';
                var location = document.createElement("input");
                location.setAttribute('type', "text");
                location.setAttribute('name', "location");
                location.setAttribute('id', 'location_field'); 
                // dialog box's startTime input field
                var startTime = document.createElement("input");
                startTime.id = "txtStartTime";
                startTime.type = "text";
                startTime.className = 'input-small';
                startTime.style.width = "85px";
                // dialog box's endTime input field
                var endTime = document.createElement("input");
                endTime.id = "txtEndTime";
                endTime.type = "text";
                endTime.className = 'input-small';
                endTime.style.width = "85px";
                // is the time in the morning (AM) or afternoon (PM)
                var start_am_pm = "PM";
                var startHour = date.getHours();
                if (startHour == 0) {
                  startHour = 12;
                  start_am_pm = "AM";
                }
                else if (startHour < 12) {
                  start_am_pm = "AM";
                }
                // if the time is PM, don't use military time (eg. 13:00 ==> 1:00)
                else if (startHour != 12) {
                  startHour = startHour - 12;
                }
                var startMinute = date.getMinutes();
                // set the initial start time to be the time that was clicked to make the event
                startTime.setAttribute('value', startHour + ':' + startMinute + ' ' + start_am_pm);

                // increment the initial end time to be one hour (3.6e6 milliseconds) later than the initial start time
                var endDateObject = new Date();
                endDateObject.setTime(date.getTime() + (60*60*1000));
                var end_am_pm = "PM";
                var endHour = endDateObject.getHours();
                if (endHour == 0) {
                  endHour = 12;
                  end_am_pm = "AM";
                }
                else if (endHour < 12) {
                  end_am_pm = "AM";
                }
                else if (endHour != 12) {
                  endHour = endHour - 12;
                }
                var endMinute = endDateObject.getMinutes();
                // set the initial start time to be the time that was clicked to make the event
                endTime.setAttribute('value', endHour + ':' + endMinute + ' ' + end_am_pm);

                // the box that holds the startTime timepicker
                var lblStartTime = document.createElement('label')
                lblStartTime.htmlFor = "txtStartTime";
                lblStartTime.appendChild(document.createTextNode('fromTime'));
                // the box that holds the endTime timepicker
                var lblEndTime = document.createElement('label')
                lblEndTime.htmlFor = "txtEndTime";
                lblEndTime.appendChild(document.createTextNode('toTime'));

                var newline = document.createElement("span");
                newline.innerHTML = ' <br/>';

                var startDate = document.createElement("input");
                startDate.id = "txtStartDate";
                startDate.type = "text";
                startDate.className = "datepicker";
                startDate.style.width = "85px";
                startDate.readonly = "readonly";

                // span makes it so there's no newline at the end, while "br" would
                // include the newline
                date_text = document.createElement("span");
                // &nbsp is a non-breaking whitespace character
                date_text.innerHTML = '<br/>Event Dates: ';

                // January is 0 so we add 1
                var startMonth = date.getMonth() + 1;
                if (startMonth < 10) {
                  startMonth = '0' + startMonth;
                }
                var startDay = date.getDate();

                if (startDay < 10) {
                  startDay = '0' + startDay;
                }
                // when editing an event, the start date is displayed
                startDate.setAttribute('value', startMonth + '/' + startDay + '/' + date.getFullYear());

                var lblStartDate = document.createElement('label')
                lblStartDate.htmlFor = "txtStartDate";
                lblStartDate.appendChild(document.createTextNode('fromDate'));

                to_text = document.createElement("span");
                // &nbsp is a non-breaking whitespace character
                to_text.innerHTML = '&nbsp to &nbsp';

                var endDate = document.createElement("input");
                endDate.id = "txtEndDate";
                endDate.type = "text";
                endDate.className = "datepicker";
                endDate.style.width = "85px";
                endDate.readonly = "readonly";

                // January is 0 so we add 1
                var endMonth = endDateObject.getMonth() + 1;
                if (endMonth < 10) {
                  endMonth = '0' + endMonth;
                }
                var endDay = endDateObject.getDate();

                if (endDay < 10) {
                  endDay = '0' + endDay;
                }

                // when editing an event, the end date is displayed
                endDate.setAttribute('value', endMonth + '/' + endDay + '/' + endDateObject.getFullYear());

                var lblEndDate = document.createElement('label')
                lblEndDate.htmlFor = "txtEndDate";
                lblEndDate.appendChild(document.createTextNode('toDate'));

                $dialog.empty().append(activity_text);
                $dialog.append(activity);

                $dialog.append(location_text);
                $dialog.append(location);

                $dialog.append(date_text)
                $dialog.append(startDate);
                $dialog.append(startTime);

                $dialog.append(to_text);

                $dialog.append(endDate);
                $dialog.append(endTime);
                $dialog.append(newline);

                // the options that our datepicker will use
                var datePickerOptions = {
                    autoclose: true,
                    todayBtn: true,
                    todayHighlight: true
                };


             /*   $(endTime).timepicker();


                startDate.onclick = function() {
                  $(endTime).timepicker(hideWidget);
                };*/



                $(startTime).timepicker();
                
                // this function is trigged when we hide the timepicker
               /* $(startTime).timepicker().on('hide.timepicker', function(e) {
                    
                  $(endTime).timepicker({
                    hideWidget: true
                  });


                }*/

                  /*{

                  modalBackdrop: true,
                  onSelect: function() {
                    console.log("here???????")
                  },
                }*/
                ////////);
                $(endTime).timepicker();

                $(startDate).datepicker(datePickerOptions);
                $(endDate).datepicker(datePickerOptions);

                var cancel = document.createElement("input");
                cancel.setAttribute('type', "submit");
                cancel.setAttribute('value', "Cancel");

                cancel.onclick = function() {
                  $dialog.dialog('close');
                };

                var submit = document.createElement("input");
                submit.setAttribute('type',"submit");
                submit.setAttribute('value', "Submit");

                submit.onclick = function() {
                  $.ajax({
                    type: "POST",
                    url: "/calendar/add_event/",
                    data: {'activity': $('#activity_field').val(),
                    'location': $('#location_field').val(),
                    'start_date': $('#txtStartDate').val(),
                    'end_date': $('#txtEndDate').val(),
                    'start_time': $('#txtStartTime').val(),
                    'end_time': $('#txtEndTime').val()
                    },
                    // data is what the server returns
                     success: function(data) {
                        // data[0] now holds the event to add
                        var data = JSON.parse(data);
                        // this flag will be false if the dates are
                        // invalid, in which case the event won't be
                        // added
                        var valid_dates = true;

                        console.log(data[0].fields.start_time);

                        // get the day, month, and year for the start and end dates
                        var start_year = data[0].fields.start_time.substring(0,4);
                        var start_month = data[0].fields.start_time.substring(5,7);
                        var start_day = data[0].fields.start_time.substring(8,10);
                        var start_hour = data[0].fields.start_time.substring(11,13);
                        var start_minute = data[0].fields.start_time.substring(14,16);
                        var start_second = data[0].fields.start_time.substring(17,19);

                        var end_year = data[0].fields.end_time.substring(0,4);
                        var end_month = data[0].fields.end_time.substring(5,7);
                        var end_day = data[0].fields.end_time.substring(8, 10);
                        var end_hour = data[0].fields.end_time.substring(11,13);
                        var end_minute = data[0].fields.end_time.substring(14,16);
                        var end_second = data[0].fields.end_time.substring(17,19);

                        var firstDate = new Date(start_year, start_month, start_day, start_hour, start_minute, start_second, 0);
                        var secondDate = new Date(end_year, end_month, end_day, end_hour, end_minute, end_second, 0);
                        
                        // don't add the event if the dates aren't chronological
                        if (firstDate >= secondDate) {
                          alert("Your event's start date must occur before its end date.");
                        }
                        else {
                          var added_event = make_events(data, 'blue', '{{username}}', false, true)[0];

                          console.log( "pk1 = " + data[0].pk );
                          console.log( "added_event.id = " + added_event.id)

                          $('#calendar').fullCalendar('renderEvent', added_event, stick = true);
                          $dialog.dialog('close');
                        }
                     },
                  });
                };
                $dialog.append(cancel);
                $dialog.append(submit);
                $dialog.dialog('open');
            }
            // single click
            else{
                doubleClick=date.toUTCString();
                clearInterval(clickTimer);
                clickTimer = setInterval(function(){
                    doubleClick = null;
                    clearInterval(clickTimer);
                }, 500);
            }
        },




    }




    );


});


      

    



  </script>


<!--
<script>

  $(document).ready(function() {
     /* $(function() {
          $('input.timepicker').timepicker();


          
      });*/
      $('#timepicker3').timepicker({
     //   template: 'dropdown',
     //   modalBackdrop: 'true',
        minuteStep: 5,
        showInputs: true,
        disableFocus: true
      });
  });
</script>

<div class="bootstrap-timepicker pull-right">
            <input id="timepicker3" type="text" class="input-small">
        </div>-->

</div>

{% endblock %}
